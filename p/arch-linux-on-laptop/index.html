<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en-us lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>Arch Linux on Laptop &#183; </title><meta name=description content="Interesting content."><meta name=keywords content="Interesting keywords."><link rel=stylesheet href=https://peromage.github.io/css/skeria.css><link rel=stylesheet href=https://peromage.github.io/css/font.awesome.6.1.2.all.min.css></head><body><div class=topbar><div class=topbar-sticky><a href=https://peromage.github.io/ style=text-decoration:none><h1>undefined behavior</h1></a><span class=lead>tb;dr - too boring; don&rsquo;t read</span>
<span class=topbar-nav><p><span class=topbar-nav-item><a href=https://peromage.github.io/>Recent</a>
</span><span class=topbar-nav-item><a href=https://peromage.github.io/posts>All Posts</a>
</span><span class=topbar-nav-item><a href=https://peromage.github.io/categories>Categories</a>
</span><span class=topbar-nav-item><a href=https://peromage.github.io/tags>Tags</a>
</span><span class=topbar-nav-item><a href=https://peromage.github.io/about>About</a>
</span><span class=topbar-nav-item><a href=https://peromage.github.io/search>Search</a></span></p></span></div></div><div class="content container"><div class=post><h1 class=post-title>Arch Linux on Laptop</h1><span class=post-date>Nov 8, 2022
&nbsp;&#183;&nbsp; 7 minute read
&nbsp;&#183;&nbsp;
<a class=label href=https://peromage.github.io/linux>linux</a></span><p>I recently got my new laptop and I found that some additional tweaks need to be made for laptops. Thus, this post is to have a record in case I forget when I have to reinstall the system.</p><h2 id=some-basic-setup>Some basic setup</h2><p>Unlike desktop, laptops have to be secure so encrytion is a must.</p><p>Details of how-to can be found on Arch wiki. I&rsquo;m not going to go through that here. However, I&rsquo;ll note down some considerations and things that need to pay attention to.</p><h3 id=encryption>Encryption</h3><p><a href=https://wiki.archlinux.org/title/dm-crypt/Encrypting_an_entire_system>Arch wiki about encryption</a> has very good examples.</p><p>In my case I use <code>LUKS2</code>. As for the scheme, I leave EFI partition unencrypted and encrypt the whole <code>BTRFS</code> partition (See <a href=#partitioning>Partitioning</a>). EFI partition also acts as boot partition (ramfs and kernel reside inside). Reason to take this approach is encrypted boot partition makes things more complicated (Like you have to decrypt the partition twice. Once from bootloader and the other one from kernel). Plus I have secure boot enabled (see <a href=#secure-boot>Secure boot</a>) so unencrypted boot partition is not really a big problem.</p><p>Quick setup.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#8f5902;font-style:italic># cryptsetup -y -v luksFormat /dev/sda2</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># cryptsetup open /dev/sda2 myroot</span>
</span></span></code></pre></div><p>A passphrase will be created to unlock the partition in slot <code>0</code>.</p><p>To tell kernel to decrypt the disk on startup, ramfs and kernel parameters have to be updated. I prefer using <code>systemd</code> rather than busybox provided by <code>udev</code>. In this case <code>sd-encrypt</code> has to be added instead of <code>encrypt</code></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cfg data-lang=cfg><span style=display:flex><span><span style=color:#8f5902;font-style:italic># /etc/mkinitcpio.conf</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>...</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>HOOKS</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>(base systemd autodetect keyboard modconf block sd-encrypt filesystems fsck)</span>
</span></span></code></pre></div><p>Then update kernel parameters to unlock and map the encrypted partition.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cfg data-lang=cfg><span style=display:flex><span><span style=color:#8f5902;font-style:italic># /boot/loader/entries/arch.conf</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>...</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>options rd.luks.name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>51d2be03-b9a4-4d4d-bc5a-0a9dba854c1f=ffroot root=/dev/mapper/ffroot</span>
</span></span></code></pre></div><p>Then we&rsquo;re going to use TPM2 to automatically decrypt on bootup. For <code>PCR</code> see <a href=https://man.archlinux.org/man/systemd-cryptenroll.1>this help page</a>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#8f5902;font-style:italic># systemd-cryptenroll /dev/sda2 --tpm2-device=auto --tpm2-pcrs=0+7 --tpm2-with-pin=true</span>
</span></span></code></pre></div><p>Alternatively you can use a more secure recovery key generated randomly instead of using your own passphrase. Assume the passphrase that was created previously is in slot <code>0</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#8f5902;font-style:italic># systemd-cryptenroll /dev/sda2 --recovery-key</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># systemd-cryptenroll /dev/sda2 --wipe-slot=0</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># systemd-cryptenroll /dev/sda2 --tpm2-device=auto --tpm2-pcrs=0+7 --tpm2-with-pin=true</span>
</span></span></code></pre></div><p>Note: It is important to keep at least a backup decryption method (recovery key or passphrase) when making modifications to slots. If only TPM slot left then you&rsquo;re probably fucked up because you can no longer add or remove key slots. Once the boot is tampered you would not be able to recover anymore.</p><h3 id=partitioning>Partitioning</h3><p>See <a href=https://wiki.archlinux.org/title/Btrfs>Arch wiki about BTRFS</a> to get to know how to setup <code>BTRFS</code> file system.</p><p>Using too many partitions is not good for SSD so I only have two partitions on the disk: EFI partition (also as boot) + a big partition formated with <code>BTRFS</code>. The second partition is encrypted, which will be demonstrated in the next topic.</p><p>With <code>BTRFS</code>, I can use subvolume to achieve the similar effect like what partition does, but it is more flexible.</p><p>These subvolumes are created under the big <code>BTRFS</code>&rsquo;s root.</p><table><thead><tr><th>Subvolume</th><th>Mount Point</th><th>Note</th></tr></thead><tbody><tr><td>@os-arch</td><td>/</td><td>System root</td></tr><tr><td>@os-arch-var</td><td>/var</td><td>Avoid getting snapshot</td></tr><tr><td>@home</td><td>/home</td><td>Separated home</td></tr><tr><td>@swap</td><td>/swap</td><td>Swap files (no compression, no CoW)</td></tr><tr><td>@snapshots</td><td>/snapshots</td><td>Snapshots</td></tr></tbody></table><p>Quick setup. Note that the swap subvolume should have no-COW flag.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#8f5902;font-style:italic># mkfs.btrfs -L ffroot /dev/mapper/ffroot</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># mount /dev/mapper/ffroot /mnt</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># btrfs subvolume create /mnt/@os-arch</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># btrfs subvolume create /mnt/@os-arch-var</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># btrfs subvolume create /mnt/@home</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># btrfs subvolume create /mnt/@vm</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># btrfs subvolume create /mnt/@swap</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># chattr +C /mnt/@vm</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># chattr +C /mnt/@swap</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># btrfs subvolume create /mnt/@snapshots</span>
</span></span></code></pre></div><p>An example of how <code>fstab</code> is set up. For SSD, I also have <code>discard=async</code> enabled.</p><p>As for the compression, it seems to be enabled for the whole file system once <a href=https://btrfs.wiki.kernel.org/index.php/Compression#Can_I_set_compression_per-subvolume.3F>one of the subvolume has it enabled</a>. A workaround is to set the property by <code>chattr +c</code>. Based on the document statement, even if I don&rsquo;t have compression option for the swap subvolume, it is enabled implicitly. The reason that I don&rsquo;t want to use property-based compression option is that it cannot specify compression method. And <code>btrfs property set &lt;file> compression &lt;zlib|lzo|zstd></code> seems to have <a href="https://www.reddit.com/r/btrfs/comments/qklux7/comment/hixefz0/?utm_source=share&amp;utm_medium=web2x&amp;context=3">some quirks</a>.</p><p>So far I haven&rsquo;t found any issues with this setup. Hope per-subvolume compression will be implemented soon.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cfg data-lang=cfg><span style=display:flex><span><span style=color:#8f5902;font-style:italic># &lt;file system&gt; &lt;dir&gt; &lt;type&gt; &lt;options&gt; &lt;dump&gt; &lt;pass&gt;</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># /dev/mapper/ffroot</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>/dev/mapper/ffroot      /               btrfs           rw,noatime,ssd,discard</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>async,space_cache=v2,compress=zstd:3,subvol=/@os-arch    0 1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># /dev/nvme0n1p1 LABEL=EFI_BOOT</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>UUID</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>4652-2467          /boot           vfat            rw,relatime,fmask=0022,dmask=0022,codepage=437,iocharset=ascii,shortname=mixed,utf8,errors=remount-ro   0 2</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># /dev/mapper/ffroot</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>/dev/mapper/ffroot      /var            btrfs           rw,noatime,ssd,discard</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>async,space_cache=v2,compress=zstd:3,subvol=/@os-arch-var        0 2</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># /dev/mapper/ffroot</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>/dev/mapper/ffroot      /home           btrfs           rw,noatime,ssd,discard</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>async,space_cache=v2,compress=zstd:3,subvol=/@home       0 2</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># /dev/mapper/ffroot</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>/dev/mapper/ffroot      /swap           btrfs           rw,noatime,ssd,discard</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>async,space_cache=v2,subvol=/@swap       0 2</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># /dev/mapper/ffroot</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>/dev/mapper/ffroot      /vm             btrfs           rw,noatime,ssd,discard</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>async,space_cache=v2,subvol=/@vm         0 2</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># swap files</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>/swap/swap32gb.img      none    swap    defaults        0       0</span>
</span></span></code></pre></div><h4 id=snapshots>Snapshots</h4><p>Thanks to CoW feature provided by BTRFS, taking snapshots is easy.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>btrfs subvolume snapshot <span style=color:#204a87>source</span> <span style=color:#ce5c00;font-weight:700>[</span>dest/<span style=color:#ce5c00;font-weight:700>]</span>name
</span></span></code></pre></div><p>Read-only snapshot requires <a href=https://wiki.archlinux.org/title/btrfs#Snapshots>additional work</a> when it gets restored. Usually I don&rsquo;t use read-only argument when creating a snapshot.</p><h3 id=secure-boot>Secure boot</h3><p>Arch wiki has a very clear <a href=https://wiki.archlinux.org/title/Unified_Extensible_Firmware_Interface/Secure_Boot>tutorial</a> but eh. It&rsquo;s too cumbersome. I choose to use <a href=https://github.com/Foxboron/sbctl>sbctl</a> to save my life.</p><p>The readme is very easy to follow but one thing needs to pay attention to is, <code>grub</code> doesn&rsquo;t work with it. If you sign <code>grub</code>&rsquo;s EFI file it will fail when secure boot is enforced. I switched to <code>systemd-boot</code> due to this reason. And I also find that <code>systemd-boot</code> is way easier to configure.</p><p>For a quick start.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#8f5902;font-style:italic># sbctl status</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># sbctl create-keys</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># sbctl enroll-keys</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># sbctl status</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># sbctl sign -s /efi/EFI/BOOT/BOOTX64.EFI</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># sbctl sign -s /efi/EFI/systemd/systemd-bootx64.efi</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># sbctl sign -s /boot/vmlinuz-linux</span>
</span></span></code></pre></div><h4 id=use-bundles--optional>Use bundles (optional)</h4><p>Alternatively, you can also bundle kernel image and ramdisk image together as an EFI file.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#8f5902;font-style:italic># sbctl bundle -s -i /boot/intel-ucode.img -k /boot/vmlinuz-linux -f /boot/initramfs-linux.img -c /proc/cmdline /boot/EFI/Linux/linux.efi</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># sbctl bundle -s -i /boot/intel-ucode.img -k /boot/vmlinuz-linux-zen -f /boot/initramfs-linux-zen.img -c /proc/cmdline /boot/EFI/Linux/linux-zen.efi</span>
</span></span></code></pre></div><p>Since the bundles are registered in <code>sbctl</code>&rsquo;s database, the EFI files will be automatically re-generated when kernel is updated.</p><p>However, in case if kernel parameter or ramdisk is updated, run this manually to re-generate new bundles.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#8f5902;font-style:italic># sbctl generate-bundles</span>
</span></span></code></pre></div><h3 id=hibernation>Hibernation</h3><p>When creating swap files, keep in mind of the following:</p><ol><li>Swap files should <strong>NOT</strong> be set with CoW attribute on <code>BTRFS</code> file system.</li><li>Use <code>dd</code> to ensure swap files don&rsquo;t have <a href=https://unix.stackexchange.com/a/659915>holes</a>.</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#8f5902;font-style:italic># chattr +C /mnt/@swap</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># dd if=/dev/zero of=/mnt/@swap/swapfile bs=1M count=8192 status=progress</span>
</span></span></code></pre></div><p>Then follow <a href=https://wiki.archlinux.org/title/Power_management/Suspend_and_hibernate#Hibernation_into_swap_file_on_Btrfs>this wiki</a> to calculate swap file physical offset on <code>BTRFS</code> partition.</p><p>Then set kernel parameters. The UUID should be the UUID of <strong>decrypted</strong> <code>BTRFS</code> partition. Differentiate from the UUID above.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cfg data-lang=cfg><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Kernel parameters</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>... resume</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>UUID=dcc33411-f4ae-46e0-ba7a-f285301b25f6 resume_offset=3420784 ...</span>
</span></span></code></pre></div><p>Update ramfs. Add <code>resume</code> hook.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cfg data-lang=cfg><span style=display:flex><span><span style=color:#c4a000>HOOKS</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>(base systemd autodetect keyboard modconf block sd-encrypt filesystems fsck resume)</span>
</span></span></code></pre></div><h3 id=overall-kernel-parameters>Overall kernel parameters</h3><p>Kernel parameters used for the previous sections include partitioning, encryption and hibernation.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cfg data-lang=cfg><span style=display:flex><span><span style=color:#c4a000>title Arch Liunx</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>linux /vmlinuz-linux</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>initrd /intel-ucode.img</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>initrd /initramfs-linux.img</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>options loglevel</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>4 quiet rw rd.luks.name=51d2be03-b9a4-4d4d-bc5a-0a9dba854c1f=ffroot root=/dev/mapper/ffroot rootflags=subvol=@arch-root mem_sleep_default=deep nvme.noacpi=1 module_blacklist=hid_sensor_hub resume=UUID=dcc33411-f4ae-46e0-ba7a-f285301b25f6 resume_offset=3420784</span>
</span></span></code></pre></div><h2 id=installing-arch-linux>Installing Arch Linux</h2><p>I have a script to handle this: <a href=https://github.com/peromage/pew/blob/master/rice/setup-scripts/arch-install.sh>https://github.com/peromage/pew/blob/master/rice/setup-scripts/arch-install.sh</a></p><h2 id=power-management>Power management</h2><p>For power management, there are two options: <code>TLP</code> and <code>power-profiles-daemon</code>.</p><p><code>TLP</code> is powerful but it needs quite a bit attention to manually manage the configuration. And most of desktop environments don&rsquo;t have integration with it by default.</p><p><code>power-profiles-daemon</code> can be used out of the box and desktop like <code>KDE</code> detects it automatically when it is installed.</p><p>Both power manager can only exist one at a time because they conflict with each other. You can mask one of them in <code>systemd</code> though. I don&rsquo;t think that&rsquo;s a good idea. To avoid scratching my head and save some hair, usually I use <code>power-profiles-daemon</code>.</p><h3 id=tlp>TLP</h3><p>My <code>TLP</code> preferences. Not too much. It might be a little aggressive since I want to have maximal battery life.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cfg data-lang=cfg><span style=display:flex><span><span style=color:#8f5902;font-style:italic># /etc/tlp.d/my-power-plan.conf</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>TLP_DEFAULT_MODE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>AC</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>TLP_PERSISTENT_DEFAULT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c4a000>CPU_SCALING_GOVERNOR_ON_AC</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>performance</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>CPU_SCALING_GOVERNOR_ON_BAT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>powersave</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c4a000>CPU_ENERGY_PERF_POLICY_ON_AC</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>balance_performance</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>CPU_ENERGY_PERF_POLICY_ON_BAT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>balance_power</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c4a000>CPU_MIN_PERF_ON_AC</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>0</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>CPU_MAX_PERF_ON_AC</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>100</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>CPU_MIN_PERF_ON_BAT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>0</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>CPU_MAX_PERF_ON_BAT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>20</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c4a000>CPU_BOOST_ON_AC</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>1</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>CPU_BOOST_ON_BAT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c4a000>CPU_HWP_DYN_BOOST_ON_AC</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>1</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>CPU_HWP_DYN_BOOST_ON_BAT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c4a000>SCHED_POWERSAVE_ON_AC</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>0</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>SCHED_POWERSAVE_ON_BAT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>1</span>
</span></span></code></pre></div><h3 id=power-profiles-daemon>power-profiles-daemon</h3><p>No configuration needed. Just remember to enable the daemon service once it&rsquo;s installed.</p><h2 id=hidpi>HiDPI</h2><p>I previously used <code>XFCE</code> but now I&rsquo;ve switched to KDE as the default desktop environment so HiDPI is not a problem anymore.</p><h2 id=firefox-scrolling-with-touchpad>Firefox scrolling with touchpad</h2><p>Yuck. Default scrolling experience on touchpad is just disgusting &ndash; it lacks kinetic scrolling. This mostly because Firefox is not configured properly.</p><p>For <code>X11</code>, add following to the profile file.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>MOZ_USE_XINPUT2</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>1</span>
</span></span></code></pre></div><p>For <code>Wayland</code>, same in the profile file.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>MOZ_ENABLE_WAYLAND</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>1</span>
</span></span></code></pre></div><h2 id=framework-laptop-specific>Framework laptop specific</h2><p>Framework laptop needs some additional tweaks.</p><h3 id=ambient-light-sensor>Ambient Light Sensor</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pacman -S iio-sensor-proxy</span>
</span></span></code></pre></div><h3 id=fingerprint>Fingerprint</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pacman -S fprintd</span>
</span></span></code></pre></div><h3 id=bluetooth>Bluetooth</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pacman -S bluez bluez-utils</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># systemctl enable --now bluetooth</span>
</span></span></code></pre></div><h3 id=touchpad-two-finger-three-finger-click>Touchpad Two-finger/Three-finger Click</h3><ol><li>Get touchpad device id</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># xinput</span>
</span></span></code></pre></div><ol><li>Add to .xinitrc</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># xinput set-prop &lt;device&gt; &#39;libinput Click Method Enabled&#39; 0 1</span>
</span></span></code></pre></div><h3 id=brightness-keys>Brightness Keys</h3><p>Add to kernel parameters:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cfg data-lang=cfg><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Kernel parameters</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>... module_blacklist</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>hid_sensor_hub ...</span>
</span></span></code></pre></div><h3 id=suspend-power>Suspend Power</h3><p>Add to kernel parameters:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cfg data-lang=cfg><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Kernel parameters</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>... mem_sleep_default</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>deep nvme.noacpi=1 ...</span>
</span></span></code></pre></div></div></div><script src=https://peromage.github.io/js/mathjax.3.2.2.tex-svg.min.js></script><div class=bottombar><div class=bottombar-sticky><div class=icons><span class=icons-item><a href=https://github.com/peromage target=_blank><i class="fab fa-github"></i></a> </span><span class=icons-item><a href=https://www.linkedin.com/in/fangdeng/ target=_blank><i class="fab fa-linkedin fa-1x"></i></a> </span><span class=icons-item><a href=mailto:fang@elfang.com><i class="fas fa-envelope fa-1x"></i></a> </span><span class=icons-item><a href=/me.pub><i class="fas fa-key fa-1x"></i></a></span></div><div class=footer><p>&copy; 2025 , <a href=https://peromage.github.io/license/>License</a><br><a href=/privacy title="Privacy notice">Privacy notice</a></p></div></div></div></body></html>
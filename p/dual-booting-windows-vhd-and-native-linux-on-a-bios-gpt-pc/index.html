<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en-us lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>Dual-booting Windows VHD and Native Linux on a BIOS+GPT PC &#183; Fang Deng</title>
<meta name=description content="Interesting content."><meta name=keywords content="Interesting keywords."><link rel=stylesheet href=https://peromage.github.io/css/skeria.css><link rel=stylesheet href=https://peromage.github.io/css/font.awesome.6.1.2.all.min.css></head><body><div class=topbar><div class=topbar-sticky><a href=https://peromage.github.io/ style=text-decoration:none><h1>undefined behavior</h1></a><span class=lead>tb;dr - too boring; don&rsquo;t read</span>
<span class=topbar-nav><p><span class=topbar-nav-item><a href=https://peromage.github.io/>Recent</a>
</span><span class=topbar-nav-item><a href=https://peromage.github.io/posts>All Posts</a>
</span><span class=topbar-nav-item><a href=https://peromage.github.io/categories>Categories</a>
</span><span class=topbar-nav-item><a href=https://peromage.github.io/tags>Tags</a>
</span><span class=topbar-nav-item><a href=https://peromage.github.io/about>About</a>
</span><span class=topbar-nav-item><a href=https://peromage.github.io/search>Search</a></span></p></span></div></div><div class="content container"><div class=post><h1 class=post-title>Dual-booting Windows VHD and Native Linux on a BIOS+GPT PC</h1><span class=post-date>Jul 9, 2021
&nbsp;&#183;&nbsp; 3 minute read
&nbsp;&#183;&nbsp;
<a class=label href=https://peromage.github.io/linux>linux</a></span><h2 id=background>Background</h2><p>Previously I wrote a post for this dual-boot scenario. It is a little outdated. In the past year I mostly worked in the Linux environment on my old laptop, so the Windows seems not to be a necessity which occupies a dedicated partition. However, sometimes it is still needed. That is why I started thinking to improve this setup even further.</p><p>Starting from Windows 7, Windows supports boots from a VHD file which makes it so much easier to manage. Also you are able to create differencing disks which are pretty much like snapshots.</p><p>For this new configuration, my plan is to use BIOS + GPT disk table + Native Linux + Native Windows booting from VHD + GRUB as the bootloader.</p><h2 id=partitioning>Partitioning</h2><p>To make GPT works with BIOS. It is required to have a small partition <a href=https://wiki.archlinux.org/title/GRUB>flagged</a> with <code>EF02</code>.</p><p>The partition scheme looks like this:</p><table><thead><tr><th style=text-align:left>Device</th><th style=text-align:left>Start</th><th style=text-align:left>End</th><th style=text-align:left>Sectors</th><th style=text-align:left>Size</th><th style=text-align:left>Type</th></tr></thead><tbody><tr><td style=text-align:left>/dev/sda1</td><td style=text-align:left>34</td><td style=text-align:left>2047</td><td style=text-align:left>2014</td><td style=text-align:left>1007K</td><td style=text-align:left>BIOS Boot</td></tr><tr><td style=text-align:left>/dev/sda2</td><td style=text-align:left>2048</td><td style=text-align:left>1026047</td><td style=text-align:left>1024000</td><td style=text-align:left>500M</td><td style=text-align:left>EFI System</td></tr><tr><td style=text-align:left>/dev/sda3</td><td style=text-align:left>1026048</td><td style=text-align:left>206546943</td><td style=text-align:left>205520896</td><td style=text-align:left>98G</td><td style=text-align:left>Linux Filesystem</td></tr><tr><td style=text-align:left>/dev/sda4</td><td style=text-align:left>206546944</td><td style=text-align:left>835692543</td><td style=text-align:left>629145600</td><td style=text-align:left>300G</td><td style=text-align:left>Linux Filesystem</td></tr><tr><td style=text-align:left>/dev/sda5</td><td style=text-align:left>835692544</td><td style=text-align:left>1465149134</td><td style=text-align:left>629456591</td><td style=text-align:left>300.1G</td><td style=text-align:left>Microsoft Basic Data</td></tr></tbody></table><h2 id=installing-linux>Installing Linux</h2><p>Any Linux distro would work. I chose Manjaro KDE this time because I found that the Pop OS made my laptop really hot sometimes (Yeah KDE is prettier).</p><p>This part should be easy. The GRUB files is going into that EFI partition. For details, check <a href=https://wiki.archlinux.org/title/GRUB>GRUB wiki</a>.</p><h2 id=preparing-to-install-windows>Preparing to Install Windows</h2><p>I&rsquo;m not going to use the standard Windwos installer since I want to install it into a VHD file. To make it work we need a Windows PE environment.</p><h3 id=preparing-images>Preparing Images</h3><p>Any Windows PE (Windows 7 and above) would work. The PE ISO image is going to <code>/boot/wepe.iso</code>.</p><p>Also a Windows ISO image is needed. For example a Windows 7 ISO named <code>windows7.iso</code> will be put in the Windows data partition.</p><h3 id=adding-windows-pe-to-grub>Adding Windows PE to GRUB</h3><p>Boot into Linux. Download Windows PE ISO file and move it to the EFI partition (EXT4 partitions might be problematic).</p><p>To load this ISO image, <code>memdisk</code> tool from <code>syslinux</code> is required. Steps as below on Arch based distro:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Installing syslinux</span>
</span></span><span style=display:flex><span>$ sudo pacman -S syslinux
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Copying memdisk to the boot partition</span>
</span></span><span style=display:flex><span>$ sudo cp /usr/lib/syslinux/bios/memdisk /boot/memdisk
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Adding Windows PE entry to GRUB.  1DB1-9C31 is the boot partition&#39;s UUID</span>
</span></span><span style=display:flex><span>$ sudo cat <span style=color:#4e9a06>&lt;&lt;EOF &gt;&gt;/etc/grub.d/40_custom
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>menuentry &#34;WePE x64&#34; {
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    search --set=root --no-floppy --fs-uuid 1DB1-9C31
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    linux16 /memdisk iso ro
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    initrd16 /wepe.iso
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>}
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Updating GRUB entries</span>
</span></span><span style=display:flex><span>$ sudo grub-mkconfig -o /boot/grub/grub.cfg
</span></span></code></pre></div><h2 id=installing-windows-to-a-vhd-file>Installing Windows to a VHD File</h2><p>After adding Windows PE to the bootloader entries, it is time to switch the working environment.</p><p>Restart the PC, then keep pression <code>shift</code> key until the GRUB menu shows up. Now navigate to the Windows PE entry and get in there.</p><h3 id=creating-a-vhd-file-for-windows>Creating a VHD File for Windows</h3><p>To create a VHD file, open a command line window and enter <code>diskpart</code></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Create a VHD file assuming the NTFS data partition is assigned with D:</span>
</span></span><span style=display:flex><span>DISKPART&gt; create vdisk <span style=color:#000>file</span><span style=color:#ce5c00;font-weight:700>=</span>d:<span style=color:#4e9a06>\w</span>indows7.vhd <span style=color:#000>maximum</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>64000</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>=</span>fixed
</span></span><span style=display:flex><span>DISKPART&gt; <span style=color:#204a87;font-weight:700>select</span> vdisk <span style=color:#000>file</span><span style=color:#ce5c00;font-weight:700>=</span>d:<span style=color:#4e9a06>\w</span>indows7.vhd
</span></span><span style=display:flex><span>DISKPART&gt; attach vdisk
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Disk table type doesn&#39;t matter but using MBR for better compatibility</span>
</span></span><span style=display:flex><span>DISKPART&gt; convert mbr
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Create the system partition and assign it with C:</span>
</span></span><span style=display:flex><span>DISKPART&gt; create partition primary
</span></span><span style=display:flex><span>DISKPART&gt; format <span style=color:#000>fs</span><span style=color:#ce5c00;font-weight:700>=</span>ntfs quick
</span></span><span style=display:flex><span>DISKPART&gt; assign <span style=color:#000>letter</span><span style=color:#ce5c00;font-weight:700>=</span>c
</span></span><span style=display:flex><span>DISKPART&gt; <span style=color:#204a87>exit</span>
</span></span></code></pre></div><p>Now the Windows image can be dumped into this VHD file.</p><h3 id=extracting-windows-image>Extracting Windows Image</h3><p>Mount the Windows ISO image to <code>E:</code> volume and open a command line window</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Get the image index.  For example the desired version&#39;s index is 1</span>
</span></span><span style=display:flex><span>&gt; dism /get-wiminfo /wimfile<span style=color:#ce5c00;font-weight:700>=</span>e:<span style=color:#4e9a06>\s</span>ources<span style=color:#4e9a06>\i</span>nstall.wim
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Extract the image.  Where E: is the Windows ISO and C: is the VHD file</span>
</span></span><span style=display:flex><span>&gt; dism /apply-image /imagefile:e:<span style=color:#4e9a06>\s</span>ources<span style=color:#4e9a06>\i</span>nstall.wim /index:1 /applydir:c:<span style=color:#4e9a06>\
</span></span></span></code></pre></div><h2 id=fixing-the-windows-bootloader>Fixing the Windows Bootloader</h2><p>Stay in Windows PE. Don&rsquo;t restart the PC. We still need to fix the bootloader for Windows.</p><p>Normally Windows cannot be booted with a GPT+MBR setup. And also loading the whole Windows VHD file through <code>memdisk</code> is not possible because it&rsquo;s too large to load into memory. To fix the boot issue a bridge is needed between Windows and GRUB.</p><p>Luckily <a href="http://reboot.pro/index.php?showtopic=19516&amp;page=2&amp;#entry184489">a small VHD image</a> can still be loaded by <code>memdisk</code>.</p><p>The idea is: GRUB -> MS Bootmgr VHD -> Windows VHD</p><h3 id=creating-a-dedicated-bootloader-image-for-windows>Creating a Dedicated Bootloader Image for Windows</h3><p>It is same with the process creating a VHD file for Windows system but this time it is a smaller file (32 MB).</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Create a small bootmgr VHD file in the data partition</span>
</span></span><span style=display:flex><span>DISKPART&gt; create vdisk <span style=color:#000>file</span><span style=color:#ce5c00;font-weight:700>=</span>d:<span style=color:#4e9a06>\b</span>ootmgr.vhd <span style=color:#000>maximum</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>32</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>=</span>fixed
</span></span><span style=display:flex><span>DISKPART&gt; <span style=color:#204a87;font-weight:700>select</span> vdisk <span style=color:#000>file</span><span style=color:#ce5c00;font-weight:700>=</span>d:<span style=color:#4e9a06>\b</span>ootmgr.vhd
</span></span><span style=display:flex><span>DISKPART&gt; attach vdisk
</span></span><span style=display:flex><span>DISKPART&gt; convert mbr
</span></span><span style=display:flex><span>DISKPART&gt; create partition primary
</span></span><span style=display:flex><span>DISKPART&gt; format <span style=color:#000>fs</span><span style=color:#ce5c00;font-weight:700>=</span>ntfs quick
</span></span><span style=display:flex><span>DISKPART&gt; assign <span style=color:#000>letter</span><span style=color:#ce5c00;font-weight:700>=</span>f
</span></span><span style=display:flex><span>DISKPART&gt; <span style=color:#204a87>exit</span>
</span></span></code></pre></div><p>Now the <code>bootmgr</code> VHD is mounted at <code>F:</code>. Then write the boot record and create boot configuration files.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>&gt; bootsect /nt60 f: /mbr
</span></span><span style=display:flex><span>&gt; bcdboot c:<span style=color:#4e9a06>\W</span>indows /l en-us /s f: /f bios
</span></span></code></pre></div><h3 id=fixing-the-bcd-entry>Fixing the BCD Entry</h3><p>At this point it should be working according to the <a href=https://docs.microsoft.com/en-us/windows-hardware/manufacture/desktop/boot-to-vhd--native-boot--add-a-virtual-hard-disk-to-the-boot-menu>Microsoft&rsquo;s document</a>. In fact it is not.</p><p>Let&rsquo;s check the BCD entries, in a command window:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>&gt; bcdedit /store f:<span style=color:#4e9a06>\B</span>oot<span style=color:#4e9a06>\B</span>CD /enum
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Windows Boot Manager
</span></span><span style=display:flex><span>--------------------
</span></span><span style=display:flex><span>identifier              <span style=color:#ce5c00;font-weight:700>{</span>bootmgr<span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>device                  <span style=color:#000>partition</span><span style=color:#ce5c00;font-weight:700>=</span>F:
</span></span><span style=display:flex><span>description             Windows Boot Manager
</span></span><span style=display:flex><span>locale                  en-us
</span></span><span style=display:flex><span>inherit                 <span style=color:#ce5c00;font-weight:700>{</span>globalsettings<span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>default                 <span style=color:#ce5c00;font-weight:700>{</span>default<span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>resumeobject            <span style=color:#ce5c00;font-weight:700>{</span>fcd67427-e033-11eb-8826-cdf90e3873d0<span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>displayorder            <span style=color:#ce5c00;font-weight:700>{</span>default<span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>toolsdisplayorder       <span style=color:#ce5c00;font-weight:700>{</span>memdiag<span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>timeout                 <span style=color:#0000cf;font-weight:700>30</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Windows Boot Loader
</span></span><span style=display:flex><span>-------------------
</span></span><span style=display:flex><span>identifier              <span style=color:#ce5c00;font-weight:700>{</span>default<span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>device                  <span style=color:#000>partition</span><span style=color:#ce5c00;font-weight:700>=</span>C:
</span></span><span style=display:flex><span>path                    <span style=color:#4e9a06>\W</span>indows<span style=color:#4e9a06>\s</span>ystem32<span style=color:#4e9a06>\w</span>inload.exe
</span></span><span style=display:flex><span>description             Windows <span style=color:#0000cf;font-weight:700>7</span>
</span></span><span style=display:flex><span>locale                  en-us
</span></span><span style=display:flex><span>inherit                 <span style=color:#ce5c00;font-weight:700>{</span>bootloadersettings<span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>osdevice                <span style=color:#000>partition</span><span style=color:#ce5c00;font-weight:700>=</span>C:
</span></span><span style=display:flex><span>systemroot              <span style=color:#4e9a06>\W</span>indows
</span></span><span style=display:flex><span>resumeobject            <span style=color:#ce5c00;font-weight:700>{</span>fcd67427-e033-11eb-8826-cdf90e3873d0<span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>nx                      OptIn
</span></span><span style=display:flex><span>detecthal               Yes
</span></span></code></pre></div><p>The <code>device</code> and <code>osdevice</code> seems to be right but once the Windows VHD is unmounted it becomes <code>unknown</code>. According to this <a href=http://www.mistyprojects.co.uk/documents/BCDEdit/files/device.htm>BCDEdit notes</a>, BCD entry records the partition&rsquo;s information such as UUID to find the correct partition during bootup. In this case the partition can&rsquo;t be found until the VHD file is mounted. But this VHD file is not mounted automatically.</p><p>Thus we need to correct this and let <code>Bootmgr</code> locate the VHD file properly.</p><p>In a command line window:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#8f5902;font-style:italic># The identifier must match the one which is showing above</span>
</span></span><span style=display:flex><span>&gt; bcdedit /store C:<span style=color:#4e9a06>\B</span>oot<span style=color:#4e9a06>\B</span>CD /set <span style=color:#ce5c00;font-weight:700>{</span>default<span style=color:#ce5c00;font-weight:700>}</span> device <span style=color:#000>vhd</span><span style=color:#ce5c00;font-weight:700>=[</span>D:<span style=color:#ce5c00;font-weight:700>]</span><span style=color:#4e9a06>\w</span>indows7.vhd
</span></span><span style=display:flex><span>&gt; bcdedit /store C:<span style=color:#4e9a06>\B</span>oot<span style=color:#4e9a06>\B</span>CD /set <span style=color:#ce5c00;font-weight:700>{</span>default<span style=color:#ce5c00;font-weight:700>}</span> osdevice <span style=color:#000>vhd</span><span style=color:#ce5c00;font-weight:700>=[</span>D:<span style=color:#ce5c00;font-weight:700>]</span><span style=color:#4e9a06>\w</span>indows7.vhd
</span></span></code></pre></div><p>If we check the BCD entry again it doesn&rsquo;t change. But if we unmount the Windows VHD it will become:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>&gt; bcdedit /store f:<span style=color:#4e9a06>\B</span>oot<span style=color:#4e9a06>\B</span>CD /enum
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Windows Boot Manager
</span></span><span style=display:flex><span>--------------------
</span></span><span style=display:flex><span>identifier              <span style=color:#ce5c00;font-weight:700>{</span>bootmgr<span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>device                  <span style=color:#000>partition</span><span style=color:#ce5c00;font-weight:700>=</span>E:
</span></span><span style=display:flex><span>description             Windows Boot Manager
</span></span><span style=display:flex><span>locale                  en-us
</span></span><span style=display:flex><span>inherit                 <span style=color:#ce5c00;font-weight:700>{</span>globalsettings<span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>default                 <span style=color:#ce5c00;font-weight:700>{</span>default<span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>resumeobject            <span style=color:#ce5c00;font-weight:700>{</span>fcd67427-e033-11eb-8826-cdf90e3873d0<span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>displayorder            <span style=color:#ce5c00;font-weight:700>{</span>default<span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>toolsdisplayorder       <span style=color:#ce5c00;font-weight:700>{</span>memdiag<span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>timeout                 <span style=color:#0000cf;font-weight:700>30</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Windows Boot Loader
</span></span><span style=display:flex><span>-------------------
</span></span><span style=display:flex><span>identifier              <span style=color:#ce5c00;font-weight:700>{</span>default<span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>device                  <span style=color:#000>vhd</span><span style=color:#ce5c00;font-weight:700>=[</span>C:<span style=color:#ce5c00;font-weight:700>]</span><span style=color:#4e9a06>\w</span>indows7.vhd
</span></span><span style=display:flex><span>path                    <span style=color:#4e9a06>\W</span>indows<span style=color:#4e9a06>\s</span>ystem32<span style=color:#4e9a06>\w</span>inload.exe
</span></span><span style=display:flex><span>description             Windows <span style=color:#0000cf;font-weight:700>7</span>
</span></span><span style=display:flex><span>locale                  en-us
</span></span><span style=display:flex><span>inherit                 <span style=color:#ce5c00;font-weight:700>{</span>bootloadersettings<span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>osdevice                <span style=color:#000>vhd</span><span style=color:#ce5c00;font-weight:700>=[</span>C:<span style=color:#ce5c00;font-weight:700>]</span><span style=color:#4e9a06>\w</span>indows7.vhd
</span></span><span style=display:flex><span>systemroot              <span style=color:#4e9a06>\W</span>indows
</span></span><span style=display:flex><span>resumeobject            <span style=color:#ce5c00;font-weight:700>{</span>fcd67427-e033-11eb-8826-cdf90e3873d0<span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>nx                      OptIn
</span></span><span style=display:flex><span>detecthal               Yes
</span></span></code></pre></div><p>The volume letter doesn&rsquo;t matter, it changes dynamically. Now <code>bootmgr</code> is able to locate the VHD file correctly.</p><h2 id=adding-windows-to-grub>Adding Windows to GRUB</h2><p>Restart PC and get into Linux.</p><p>Modify the GRUB config file to load <code>bootmgr</code></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Adding Windows (bootmgr) entry to GRUB.  1DB1-9C31 is the boot partition&#39;s UUID</span>
</span></span><span style=display:flex><span>$ sudo cat <span style=color:#4e9a06>&lt;&lt;EOF &gt;&gt;/etc/grub.d/40_custom
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>menuentry &#34;Windows 7&#34; {
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    search --set=root --no-floppy --fs-uuid 1DB1-9C31
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    linux16 /memdisk harddisk
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    initrd16 /bootmgr.vhd
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>}
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Updating GRUB entries</span>
</span></span><span style=display:flex><span>$ sudo grub-mkconfig -o /boot/grub/grub.cfg
</span></span></code></pre></div><p>Now we can restart PC. Keep pressing <code>shift</code> on bootup to go to the GRUB menu. Select Windows entry to boot Windows.</p><h2 id=fixing-windows-initialization-error>Fixing Windows Initialization Error</h2><p>During the first time bootup, Windows might have an error showing</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>Windows could not complete the installation.  To install Windows on this computer, restart the installation.
</span></span></code></pre></div><p>To <a href=https://www.howisolve.com/windows-could-not-complete-the-installation-solved/>solve</a> this error:</p><ol><li>Press <code>SHIFT + F10</code> to bring up the command prompt.</li><li>Execute <code>C:\windows\system32\oobe\msoobe</code>.</li><li>Wait for a while and the setup window will show up.</li><li>Complete the setup and restart.</li></ol><h2 id=creating-a-differencing-disk>Creating a Differencing Disk</h2><p>A differencing disk can be used for quick recoveries.</p><p>To create it, restart into the Windows PE environment. In a command line window:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Use the original VHD as base</span>
</span></span><span style=display:flex><span>&gt; move d:<span style=color:#4e9a06>\w</span>indows7.vhd d:<span style=color:#4e9a06>\w</span>indows7_base.vhd
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Create a differencing disk based on the original one</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># The name of the new differencing disk has to be the name that was recorded in the BCD</span>
</span></span><span style=display:flex><span>&gt; diskpart
</span></span><span style=display:flex><span>DISKPART&gt; creat vdisk <span style=color:#000>file</span><span style=color:#ce5c00;font-weight:700>=</span>d:<span style=color:#4e9a06>\w</span>indows7.vhd <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>=</span>d:<span style=color:#4e9a06>\w</span>indows7_base.vhd
</span></span></code></pre></div><p>Then all changes made in the future will go into the differencing disk. If system goes wrong one day, simply deleting the the differencing disk and creating a new one would quickly recover from the crysis.</p><p><strong>NOTE: After creating the differencing disk, the base VHD is not supposed to be modified.</strong></p><h2 id=references>References</h2><ul><li><a href=https://wiki.archlinux.org/title/GRUB>GRUB wiki</a></li><li><a href=https://wzyboy.im/post/1049.html>BIOS + GPT + GRUB + Linux + Windows 折腾笔记</a></li><li><a href=https://rimo.site/2017/02/08/install-win7-into-vhd/>在 VHD 中安装 Windows 7</a></li><li><a href="http://reboot.pro/index.php?showtopic=19516&amp;page=2&amp;#entry184489">Hack Bootmgr to boot Windows in BIOS to GPT</a></li><li><a href=https://docs.microsoft.com/en-us/windows-hardware/manufacture/desktop/boot-to-vhd--native-boot--add-a-virtual-hard-disk-to-the-boot-menu>Boot to a virtual hard disk: Add a VHDX or VHD to the boot menu</a></li><li><a href=http://www.mistyprojects.co.uk/documents/BCDEdit/files/device.htm>BCDEdit notes</a></li><li><a href=https://www.howisolve.com/windows-could-not-complete-the-installation-solved/>100% Solved:Windows could not complete the installation</a></li></ul></div></div><script src=https://peromage.github.io/js/mathjax.3.2.2.tex-svg.min.js></script><div class=bottombar><div class=bottombar-sticky><div class=icons><span class=icons-item><a href=https://github.com/peromage target=_blank><i class="fab fa-github"></i></a> </span><span class=icons-item><a href=https://www.linkedin.com/in/fangdeng/ target=_blank><i class="fab fa-linkedin fa-1x"></i></a> </span><span class=icons-item><a href=mailto:fang@elfang.com><i class="fas fa-envelope fa-1x"></i></a> </span><span class=icons-item><a href=/pub.txt><i class="fas fa-key fa-1x"></i></a></span></div><div class=footer><p>&copy; 2024 Fang Deng, <a href=https://peromage.github.io/license/>License</a><br><a href=/privacy title="Privacy notice">Privacy notice</a></p></div></div></div></body></html>
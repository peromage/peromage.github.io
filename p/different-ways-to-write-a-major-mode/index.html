<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en-us lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>Different Ways to Write a Major Mode &#183; Fang Deng</title><meta name=description content="Interesting content."><meta name=keywords content="Interesting keywords."><link rel=stylesheet href=https://peromage.github.io/css/skeria.css><link rel=stylesheet href=https://peromage.github.io/css/font.awesome.6.1.2.all.min.css></head><body><div class=topbar><div class=topbar-sticky><a href=https://peromage.github.io/ style=text-decoration:none><h1>undefined behavior</h1></a><span class=lead>tb;dr - too boring; don&rsquo;t read</span>
<span class=topbar-nav><p><span class=topbar-nav-item><a href=https://peromage.github.io/>Recent</a></span>
<span class=topbar-nav-item><a href=https://peromage.github.io/posts>All Posts</a></span>
<span class=topbar-nav-item><a href=https://peromage.github.io/categories>Categories</a></span>
<span class=topbar-nav-item><a href=https://peromage.github.io/tags>Tags</a></span>
<span class=topbar-nav-item><a href=https://peromage.github.io/about>About</a></span>
<span class=topbar-nav-item><a href=https://peromage.github.io/search>Search</a></span></p></span></div></div><div class="content container"><div class=post><h1 class=post-title>Different Ways to Write a Major Mode</h1><span class=post-date>Mar 16, 2023
&nbsp;&#183;&nbsp; 3 minute read
&nbsp;&#183;&nbsp;
<a class=label href=https://peromage.github.io/emacs>emacs</a></span><p>This post mainly helps myself remember how to quickly write a major mode. My memory is getting worse. So sad. :(</p><h2 id=use-define-derived-mode>Use define-derived-mode</h2><p>Doc: <a href=https://www.gnu.org/software/emacs/manual/html_node/elisp/Derived-Modes.html>https://www.gnu.org/software/emacs/manual/html_node/elisp/Derived-Modes.html</a></p><p>This perhaps the most common way to write a major mode.</p><p>Most of the times I derive from <code>fundamental-mode</code>, or <code>nil</code> if the parent mode is not needed (a brand new mode).</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elisp data-lang=elisp><span style=display:flex><span><span style=color:#8f5902;font-style:italic>;; With a parent mode</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>define-derived-mode</span> <span style=color:#000>foo-mode</span> <span style=color:#000>fundamental-mode</span> <span style=color:#4e9a06>&#34;Foo&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>(</span><span style=color:#204a87>do</span> <span style=color:#000>something</span><span style=color:#000;font-weight:700>))</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>;; Or nothing</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>define-derived-mode</span> <span style=color:#000>foo-mode</span> <span style=color:#000>nil</span> <span style=color:#4e9a06>&#34;Foo&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>(</span><span style=color:#204a87>do</span> <span style=color:#000>something</span><span style=color:#000;font-weight:700>))</span>
</span></span></code></pre></div><p>Here is the common pattern that I use. I use <code>:after-hook</code> keyword to run some additional setups after the major mode call. This is useful if some of the settings need to be overridden from the parent mode settings or its hooks.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elisp data-lang=elisp><span style=display:flex><span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>define-derived-mode</span> <span style=color:#000>long-log-mode</span> <span style=color:#000>so-long-mode</span> <span style=color:#4e9a06>&#34;LongLog&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;A major mode used for large text files.  Based on </span><span style=color:#4e9a06>`so-long-mode&#39;</span><span style=color:#4e9a06>.
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>Buffers with this mode enabled are read-only by default.&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87>:interactive</span> <span style=color:#000>t</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87>:after-hook</span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic>;; Override the settings by `so-long-mode&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>(</span><span style=color:#204a87>progn</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>(</span><span style=color:#000>toggle-truncate-lines</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>(</span><span style=color:#000>hl-line-mode</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>))</span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic>;; `long-log-mode&#39; settings start from here</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>(</span><span style=color:#000>add-to-list</span> <span style=color:#4e9a06>&#39;so-long-minor-modes</span> <span style=color:#4e9a06>&#39;line-number-mode</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>(</span><span style=color:#000>read-only-mode</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>))</span>
</span></span></code></pre></div><p><strong>Note</strong>: The parent mode hooks will be executed anyway even if <code>delay-mode-hooks</code> is used in the body. To avoid this, see <a href=#use-defun>Use defun</a>.</p><h2 id=use-define-generic-mode>Use define-generic-mode</h2><p>Doc: <a href=https://www.gnu.org/software/emacs/manual/html_node/elisp/Generic-Modes.html>https://www.gnu.org/software/emacs/manual/html_node/elisp/Generic-Modes.html</a></p><p>This is useful when I need a major mode with some syntax highlights. Quick and dirty.</p><p>The third argument <code>keyword-list</code> is a shorthand which will be highlighted with <code>font-lock-keyword-face</code>. It is equivalent to using the forth argument <code>font-lock-list</code> and setting it there. For more information about font lock, see <a href=https://www.gnu.org/software/emacs/manual/html_node/elisp/Search_002dbased-Fontification.html>here</a>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elisp data-lang=elisp><span style=display:flex><span><span style=color:#8f5902;font-style:italic>;; This example is taken from EmacsWiki: https://www.emacswiki.org/emacs/GenericMode</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>define-generic-mode</span>
</span></span><span style=display:flex><span>    <span style=color:#4e9a06>&#39;foo-mode</span>                       <span style=color:#8f5902;font-style:italic>;; name of the mode to create</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>&#39;</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;!!&#34;</span><span style=color:#000;font-weight:700>)</span>                           <span style=color:#8f5902;font-style:italic>;; comments start with &#39;!!&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>&#39;</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;account&#34;</span> <span style=color:#4e9a06>&#34;user&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#4e9a06>&#34;password&#34;</span><span style=color:#000;font-weight:700>)</span>                     <span style=color:#8f5902;font-style:italic>;; some keywords</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>&#39;</span><span style=color:#000;font-weight:700>((</span><span style=color:#4e9a06>&#34;=&#34;</span> <span style=color:#ce5c00;font-weight:700>.</span> <span style=color:#4e9a06>&#39;font-lock-operator</span><span style=color:#000;font-weight:700>)</span>     <span style=color:#8f5902;font-style:italic>;; &#39;=&#39; is an operator</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;;&#34;</span> <span style=color:#ce5c00;font-weight:700>.</span> <span style=color:#4e9a06>&#39;font-lock-builtin</span><span style=color:#000;font-weight:700>))</span>     <span style=color:#8f5902;font-style:italic>;; &#39;;&#39; is a built-in</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>&#39;</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;\\.foo$&#34;</span><span style=color:#000;font-weight:700>)</span>                      <span style=color:#8f5902;font-style:italic>;; files for which to activate this mode</span>
</span></span><span style=display:flex><span>  <span style=color:#000>nil</span>                               <span style=color:#8f5902;font-style:italic>;; other functions to call</span>
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;A mode for foo files&#34;</span>            <span style=color:#8f5902;font-style:italic>;; doc string for this mode</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>)</span>
</span></span></code></pre></div><p><strong>Note</strong>: Any major mode hook will be executed anyway even if <code>delay-mode-hooks</code> is used in the last function list. To avoid this, see <a href=#use-defun>Use defun</a>.</p><h2 id=use-defun>Use defun</h2><p>Sometimes I just want to use the syntax table and font locks from a major mode but don&rsquo;t want to invoke any hooks from it, LSP per say. Using <code>define-derived-mode</code> or <code>define-generic-mode</code> will not work since the major mode hooks will be called anyway at the end of major mode call (this is default behavior defined in those macro). However, we can simply define a function and use <code>delay-mode-hooks</code> to bypass this restriction.</p><p>A pattern that I commonly use.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elisp data-lang=elisp><span style=display:flex><span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>defun</span> <span style=color:#000>foo-mode</span> <span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>(</span><span style=color:#204a87>interactive</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>(</span><span style=color:#204a87>delay-mode-hooks</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>python-mode</span><span style=color:#000;font-weight:700>))</span>     <span style=color:#8f5902;font-style:italic>;; Use the parent major mode except the hooks</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>(</span><span style=color:#204a87>setq</span> <span style=color:#000>mode-name</span> <span style=color:#4e9a06>&#34;Foo&#34;</span><span style=color:#000;font-weight:700>)</span>               <span style=color:#8f5902;font-style:italic>;; Don&#39;t forget the name your mode</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>(</span><span style=color:#204a87>setq</span> <span style=color:#000>major-mode</span> <span style=color:#000>#&#39;</span><span style=color:#000>foo-mode</span><span style=color:#000;font-weight:700>)</span>         <span style=color:#8f5902;font-style:italic>;; Don&#39;t forget the major mode symbol</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>(</span><span style=color:#204a87>setq-local</span> <span style=color:#000>indent-tabs-mode</span> <span style=color:#000>nil</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>(</span><span style=color:#204a87>setq-local</span> <span style=color:#000>tab-width</span> <span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>))</span>
</span></span></code></pre></div><p>Happy hacking!</p></div></div><script src=https://peromage.github.io/js/mathjax.3.2.2.tex-svg.min.js></script><div class=bottombar><div class=bottombar-sticky><div class=icons><span class=icons-item><a href=https://github.com/peromage target=_blank><i class="fab fa-github"></i></a></span>
<span class=icons-item><a href=https://www.linkedin.com/in/fangdeng/ target=_blank><i class="fab fa-linkedin fa-1x"></i></a></span>
<span class=icons-item><a href=mailto:fang@elfang.com><i class="fas fa-envelope fa-1x"></i></a></span>
<span class=icons-item><a href=/me.pub><i class="fas fa-key fa-1x"></i></a></span></div><div class=footer><p>&copy; 2023 Fang Deng, <a href=https://peromage.github.io/license/>License</a><br><a href=/privacy title="Privacy notice">Privacy notice</a></p></div></div></div></body></html>
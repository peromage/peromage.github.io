<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en-us lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>[Archive] Multiboot USB &#183; Fang Deng</title><meta name=description content="Interesting content."><meta name=keywords content="Interesting keywords."><link rel=stylesheet href=https://peromage.github.io/css/skeria.css><link rel=stylesheet href=https://peromage.github.io/css/font.awesome.6.1.2.all.min.css></head><body><div class=topbar><div class=topbar-sticky><a href=https://peromage.github.io/ style=text-decoration:none><h1>undefined behavior</h1></a><span class=lead>tb;dr - too boring; don&rsquo;t read</span>
<span class=topbar-nav><p><span class=topbar-nav-item><a href=https://peromage.github.io/>Recent</a></span>
<span class=topbar-nav-item><a href=https://peromage.github.io/posts>All Posts</a></span>
<span class=topbar-nav-item><a href=https://peromage.github.io/categories>Categories</a></span>
<span class=topbar-nav-item><a href=https://peromage.github.io/tags>Tags</a></span>
<span class=topbar-nav-item><a href=https://peromage.github.io/about>About</a></span>
<span class=topbar-nav-item><a href=https://peromage.github.io/search>Search</a></span></p></span></div></div><div class="content container"><div class=post><h1 class=post-title>[Archive] Multiboot USB</h1><span class=post-date>Aug 27, 2023
&nbsp;&#183;&nbsp; 1 minute read
&nbsp;&#183;&nbsp;
<a class=label href=https://peromage.github.io/tech>tech</a></span><p>Boot from any ISO file</p><h2 id=hybrid-uefi-gpt-plus-bios-mbr-gpt-boot>Hybrid UEFI GPT + BIOS MBR/GPT boot</h2><h3 id=preparation>Preparation</h3><p>Create 3 partitions on a removable USB stick.</p><ol><li>A BIOS boot partition (gdisk type code <code>EF02</code>, or GUID <code>21686148-6449-6E6F-744E-656564454649</code>) with no filesystem. This partition can be put in any place on the disk but it is recommended to put it at the begginning from sector 34 to 2047. At minimal 1 MiB.</li><li>An EFI System partition (gdisk type code <code>EF00</code>) with a FAT32 filesystem. This partition can be as small as 50 MiB but it is better to set at least 256 MiB (550 MiB recommended).</li><li>Data partition (use a filesystem supported by GRUB). This partition can take up the rest of the space of the drive.</li></ol><h3 id=grub-installation>GRUB Installation</h3><p>Mount EFI and data partitions.
First install GRUB for UEFI:</p><pre tabindex=0><code class=language-nil data-lang=nil># grub-install --target=x86_64-efi --recheck --removable --efi-directory=/EFI_MOUNTPOINT --boot-directory=/DATA_MOUNTPOINT/boot
</code></pre><p>Then GRUB for BIOS:</p><pre tabindex=0><code class=language-nil data-lang=nil># grub-install --target=i386-pc --recheck --boot-directory=/DATA_MOUNTPOINT/boot /dev/sdX
</code></pre><p>As an additional fallback, GRUB on the MBR-bootable data partition can be installed:</p><pre tabindex=0><code class=language-nil data-lang=nil># grub-install --target=i386-pc --recheck --boot-directory=/DATA_MOUNTPOINT/boot /dev/sdX3
</code></pre><h3 id=grub-configuration>GRUB Configuration</h3><h4 id=using-a-template>Using a Template</h4><p>There are some git projects which provide some pre-existing GRUB configuration files, and a nice generic grub.cfg which can be used to load the other boot entries on demand, showing them only if the specified ISO files - or folders containing them - are present on the drive.
<a href=https://github.com/aguslr/multibootusb>Multiboot USB</a>
<a href=https://github.com/thias/glim>GLIM (GRUB2 Live ISO Multiboot)</a></p><h4 id=using-manual-configuration>Using Manual Configuration</h4><ol><li>Install memdisk module from Syslinux:</li></ol><pre tabindex=0><code class=language-nil data-lang=nil># cp /usr/lib/syslinux/bios/memdisk /DATA_MOUNTPOINT/boot/
</code></pre><ol><li><p>Finding the partition where image files are located by persistent name is recommended. To get this done by using either filesystem UUID or partition label <strong>(this step is not necessarily required due to iso files are located on the same partition)</strong>.</p></li><li><p>A template configuration can be found below. Note: <code>/DATA_MOUNTPOINT/boot/</code> is for GRUB boot files and <code>/DATA_MOUNTPOINT/iso/</code> is for images. Those directories can be variant.</p></li></ol><pre tabindex=0><code class=language-nil data-lang=nil>#/DATA_MOUNTPOINT/boot/grub/grub.cfg
## insert modules

# if on ntfs with compression on
#insmode ntfscomp


## path variables
set isopath=${root}/iso
set memdisk=${prefix}/memdisk

# path to the partition holding ISO images (using UUID)
#probe -u $root --set=rootuuid
#set imgdevpath=&#34;/dev/disk/by-uuid/$rootuuid&#34;

# path to the partition holding ISO images (using UUID explicitly)
#set imgdevpath=&#34;/dev/disk/by-uuid/UUID_value

# path to the partition holding ISO images (using UUID searching)
#search --set=imgdevpath --no-floppy --fs-uuid UUID_value

# path to the partition holding ISO images (using labels)
#set imgdevpath=&#34;/dev/disk/by-label/label_value&#34;

# path to the partition holding ISO images (using file searching)
#search --set=part --no-floppy --file PATH_TO_FILE

menuentry &#34;Generic ISO Boot Menu&#34; {
	linux16 ${memdisk} iso ro
	initrd16 ${isopath}/PATH_TO_ISO
}
</code></pre><h2 id=references>References</h2><p><a href=https://wzyboy.im/post/1049.html>BIOS + GPT + GRUB + Linux + Windows 折腾笔记</a>
<a href=https://wiki.archlinux.org/index.php/GRUB>Arch Linux Wiki: GRUB</a>
<a href=https://wiki.archlinux.org/index.php/EFI_system_partition>Arch Linux Wiki: EFI system partition</a>
<a href=https://wiki.archlinux.org/index.php/Multiboot_USB_drive>Arch Linux Wiki: Multiboot USB drive</a>
<a href=https://en.wikipedia.org/wiki/GUID_Partition_Table>Wiki: GUID Partition Table</a></p></div></div><script src=https://peromage.github.io/js/mathjax.3.2.2.tex-svg.min.js></script><div class=bottombar><div class=bottombar-sticky><div class=icons><span class=icons-item><a href=https://github.com/peromage target=_blank><i class="fab fa-github"></i></a></span>
<span class=icons-item><a href=https://www.linkedin.com/in/fangdeng/ target=_blank><i class="fab fa-linkedin fa-1x"></i></a></span>
<span class=icons-item><a href=mailto:fang@elfang.com><i class="fas fa-envelope fa-1x"></i></a></span>
<span class=icons-item><a href=/me.pub><i class="fas fa-key fa-1x"></i></a></span></div><div class=footer><p>&copy; 2023 Fang Deng, <a href=https://peromage.github.io/license/>License</a><br><a href=/privacy title="Privacy notice">Privacy notice</a></p></div></div></div></body></html>
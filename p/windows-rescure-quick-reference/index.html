<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en-us lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>Windows Rescure Quick Reference &#183; </title><meta name=description content="Interesting content."><meta name=keywords content="Interesting keywords."><link rel=stylesheet href=https://peromage.github.io/css/skeria.css><link rel=stylesheet href=https://peromage.github.io/css/font.awesome.6.1.2.all.min.css></head><body><div class=topbar><div class=topbar-sticky><a href=https://peromage.github.io/ style=text-decoration:none><h1>undefined behavior</h1></a><span class=lead>tb;dr - too boring; don&rsquo;t read</span>
<span class=topbar-nav><p><span class=topbar-nav-item><a href=https://peromage.github.io/>Recent</a>
</span><span class=topbar-nav-item><a href=https://peromage.github.io/posts>All Posts</a>
</span><span class=topbar-nav-item><a href=https://peromage.github.io/categories>Categories</a>
</span><span class=topbar-nav-item><a href=https://peromage.github.io/tags>Tags</a>
</span><span class=topbar-nav-item><a href=https://peromage.github.io/about>About</a>
</span><span class=topbar-nav-item><a href=https://peromage.github.io/search>Search</a></span></p></span></div></div><div class="content container"><div class=post><h1 class=post-title>Windows Rescure Quick Reference</h1><span class=post-date>Oct 19, 2022
&nbsp;&#183;&nbsp; 4 minute read
&nbsp;&#183;&nbsp;
<a class=label href=https://peromage.github.io/software>software</a></span><p>Though I&rsquo;ve written posts about <a href=/p/dual-booting-windows-vhd-and-native-linux-on-a-bios-gpt-pc/>dual-booting Windows and Linux</a> and <a href=/p/minimalists-multi-boot-usb-drive/>multi-booting a USB drive</a>, I have to go back and dig useful information out each time when I forget something.</p><p>After breaking my dual-boot setup once again (forgot to backup boot partition), I decided to create this post for a quick reference.</p><p>This reference assumes system is boot from UEFI and Windows is installed on a dedicated partition.</p><h2 id=setup-a-usb-with-system-images>Setup A USB With System Images</h2><p>Forget the previous multi-boot USB post. Use <a href=https://www.ventoy.net/en/index.html>Ventory</a> and it just works great.</p><p>In this case we need a Linux and Windows ISO. For Linux, I prefer Arch. For Windows, we need a PE environment. I don&rsquo;t trust those PE ISOs from other people so the best way is to download an official image from Microsoft since we just need some tools and they are included in the installation ISO already.</p><h2 id=method-1-load-windows-from-grub>Method 1: Load Windows From GRUB</h2><p>To prevent Windows from messing up with Linux&rsquo;s bootloader, a good idea is to put Windows&rsquo; bootloader in a VHD file and chainload it from GRUB.</p><h3 id=fix-windows-s-bootloader>Fix Windows&rsquo;s Bootloader</h3><p>Boot into Windows installation ISO.</p><p>Don&rsquo;t start installing. Instead, choose <code>Repair your computer</code> -> <code>Troubleshoot</code> -> <code>Command Prompt</code>.</p><p>We need to create a VHD that contains Windows bootmgr. I used to create a file in 32 MB but it seems too small for the most recent bloated Windows so in case, we use 128 MB here.</p><p>NOTE: This file will be loaded into memory so don&rsquo;t make it too big.</p><p>In diskpart, use <code>list volume</code> to confirm EFI partition volume letter. Usually it will not be assigned by PE environment automatically.</p><p>NOTE: The file can be put in Windows partition though. It requires extra setup like load NTFS module for grub and find it&rsquo;s root. That&rsquo;s too cumbersome.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>&gt; diskpart
</span></span><span style=display:flex><span>DISKPART&gt; list volume
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># EFI partition</span>
</span></span><span style=display:flex><span>DISKPART&gt; <span style=color:#204a87;font-weight:700>select</span> volume <span style=color:#0000cf;font-weight:700>2</span>
</span></span><span style=display:flex><span>DISKPART&gt; assign <span style=color:#000>letter</span><span style=color:#ce5c00;font-weight:700>=</span>e
</span></span><span style=display:flex><span>DISKPART&gt; create vdisk <span style=color:#000>file</span><span style=color:#ce5c00;font-weight:700>=</span>e:<span style=color:#4e9a06>\b</span>ootmgr.vhd <span style=color:#000>maximum</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>128</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>=</span>fixed
</span></span><span style=display:flex><span>DISKPART&gt; <span style=color:#204a87;font-weight:700>select</span> vdisk <span style=color:#000>file</span><span style=color:#ce5c00;font-weight:700>=</span>e:<span style=color:#4e9a06>\b</span>ootmgr.vhd
</span></span><span style=display:flex><span>DISKPART&gt; attach vdisk
</span></span><span style=display:flex><span>DISKPART&gt; convert mbr
</span></span><span style=display:flex><span>DISKPART&gt; create partition primary
</span></span><span style=display:flex><span>DISKPART&gt; format <span style=color:#000>fs</span><span style=color:#ce5c00;font-weight:700>=</span>ntfs quick
</span></span><span style=display:flex><span>DISKPART&gt; assign <span style=color:#000>letter</span><span style=color:#ce5c00;font-weight:700>=</span>f
</span></span><span style=display:flex><span>DISKPART&gt; <span style=color:#204a87>exit</span>
</span></span></code></pre></div><p>Now the bootloader VHD is mounted at <code>F:</code>. Then write the boot record and create boot configuration files.</p><p>NOTE: Windows partition volume letter should be confirmed in <code>diskpart</code> above. It&rsquo;s usually assigned by PE automatically. In this case it is <code>C:</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>&gt; bootsect /nt60 e: /mbr
</span></span><span style=display:flex><span>&gt; bcdboot c:<span style=color:#4e9a06>\W</span>indows /l en-us /s e: /f uefi
</span></span></code></pre></div><h3 id=add-window-to-grub>Add Window to GRUB</h3><p>Boot into Linux and confirm EFI partition UUID where you put the Windows bootloader VHD file. In command line:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ lsblk -f
</span></span></code></pre></div><p>Configure GRUB menu to include Windows. Assume the EFI partition is mounted at <code>/boot/efi</code> and <code>memdisk</code> (got from <code>syslinux</code>) is put at EFI partition&rsquo;s root.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ sudo cat <span style=color:#4e9a06>&lt;&lt;EOF &gt;&gt;/etc/grub.d/40_custom
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>menuentry &#34;Windows 10&#34; {
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    search --set=root --no-floppy --fs-uuid 1DB1-9C31
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    linux16 /memdisk harddisk
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    initrd16 /bootmgr.vhd
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>}
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ sudo grub-mkconfig -o /boot/grub/grub.cfg
</span></span></code></pre></div><h3 id=problem>Problem</h3><p>I found that on Fedora <code>linux16</code> and <code>initrd16</code> is not available by default. A workaround must be done. If it comes in this case, I suggest to use method 2 below.</p><h2 id=method-2-add-windows-back-to-uefi-menu>Method 2: Add Windows Back To UEFI Menu</h2><p>This method is simpler and it takes advantage of UEFI boot menu but there is possibility that Windows is going to break Linux if Linux is the default.</p><h3 id=fix-windows-s-bootloader>Fix Windows&rsquo;s Bootloader</h3><p>Boot into Windows installation ISO.</p><p>Don&rsquo;t start installing. Instead, choose <code>Repair your computer</code> -> <code>Troubleshoot</code> -> <code>Command Prompt</code>.</p><p>In diskpart, use <code>list volume</code> to confirm EFI partition volume letter. Usually it will not be assigned by PE environment automatically.</p><p>First, mount EFI partition and backup Linux EFI files because Windows will overwrite the default settings :).</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>&gt; diskpart
</span></span><span style=display:flex><span>DISKPART&gt; list volume
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># EFI partition</span>
</span></span><span style=display:flex><span>DISKPART&gt; <span style=color:#204a87;font-weight:700>select</span> volume <span style=color:#0000cf;font-weight:700>2</span>
</span></span><span style=display:flex><span>DISKPART&gt; assign <span style=color:#000>letter</span><span style=color:#ce5c00;font-weight:700>=</span>e
</span></span><span style=display:flex><span>DISKPART&gt; <span style=color:#204a87>exit</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Backup default UEFI entry (Linux)</span>
</span></span><span style=display:flex><span>&gt; <span style=color:#204a87>cd</span> /d e:<span style=color:#4e9a06>\E</span>FI
</span></span><span style=display:flex><span>&gt; ren BOOT linux_BOOT
</span></span></code></pre></div><p>Then Create Windows boot files.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Windows volume is C: confirmed from diskpart above</span>
</span></span><span style=display:flex><span>&gt; bcdboot c:<span style=color:#4e9a06>\W</span>indows /l en-us /s e: /f uefi
</span></span></code></pre></div><p>Lastly, restore Linux as the default start option. If you want Windows to be the default, leave it as it.</p><p>NOTE: For Fedora it seems to be a problem to be a none-default entry when log into display manager. Not sure why. So it&rsquo;d be better to restore default for Fedora.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Restore default Linux entry</span>
</span></span><span style=display:flex><span>&gt; ren Boot Microsoft_Boot
</span></span><span style=display:flex><span>&gt; ren linux_BOOT BOOT
</span></span></code></pre></div></div></div><script src=https://peromage.github.io/js/mathjax.3.2.2.tex-svg.min.js></script><div class=bottombar><div class=bottombar-sticky><div class=icons><span class=icons-item><a href=https://github.com/peromage target=_blank><i class="fab fa-github"></i></a> </span><span class=icons-item><a href=https://www.linkedin.com/in/fangdeng/ target=_blank><i class="fab fa-linkedin fa-1x"></i></a> </span><span class=icons-item><a href=mailto:fang@elfang.com><i class="fas fa-envelope fa-1x"></i></a> </span><span class=icons-item><a href=/me.pub><i class="fas fa-key fa-1x"></i></a></span></div><div class=footer><p>&copy; 2025 , <a href=https://peromage.github.io/license/>License</a><br><a href=/privacy title="Privacy notice">Privacy notice</a></p></div></div></div></body></html>
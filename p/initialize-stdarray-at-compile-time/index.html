<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en-us lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>Initialize std::array at Compile Time &#183; Fang Deng</title>
<meta name=description content="Interesting content."><meta name=keywords content="Interesting keywords."><link rel=stylesheet href=https://peromage.github.io/css/skeria.css><link rel=stylesheet href=https://peromage.github.io/css/font.awesome.6.1.2.all.min.css></head><body><div class=topbar><div class=topbar-sticky><a href=https://peromage.github.io/ style=text-decoration:none><h1>undefined behavior</h1></a><span class=lead>tb;dr - too boring; don&rsquo;t read</span>
<span class=topbar-nav><p><span class=topbar-nav-item><a href=https://peromage.github.io/>Recent</a>
</span><span class=topbar-nav-item><a href=https://peromage.github.io/posts>All Posts</a>
</span><span class=topbar-nav-item><a href=https://peromage.github.io/categories>Categories</a>
</span><span class=topbar-nav-item><a href=https://peromage.github.io/tags>Tags</a>
</span><span class=topbar-nav-item><a href=https://peromage.github.io/about>About</a>
</span><span class=topbar-nav-item><a href=https://peromage.github.io/search>Search</a></span></p></span></div></div><div class="content container"><div class=post><h1 class=post-title>Initialize std::array at Compile Time</h1><span class=post-date>Mar 16, 2022
&nbsp;&#183;&nbsp; 2 minute read
&nbsp;&#183;&nbsp;
<a class=label href=https://peromage.github.io/coding>coding</a></span><h2 id=background>Background</h2><p>I&rsquo;ve been working on optimization for some C++ code recently. One of the part is to initialize some data at compile time. Consider we have a C style enum definition:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#204a87;font-weight:700>typedef</span> <span style=color:#204a87;font-weight:700>enum</span> <span style=color:#000>Foo</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>AAA</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>    <span style=color:#000>BBB</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>    <span style=color:#000>CCC</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span> <span style=color:#000>Foo_t</span><span style=color:#000;font-weight:700>;</span>
</span></span></code></pre></div><p>We want to have an array of the enum with undefined initial values <code>999</code> because by default initialization the values would be <code>0</code>&rsquo;s. However, <code>std::array</code> can only be initialized by initializer list, which is said:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// Partial initialization
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>constexpr</span> <span style=color:#000>std</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Foo_t</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>5</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>array</span> <span style=color:#000;font-weight:700>{</span><span style=color:#204a87;font-weight:700>static_cast</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Foo_t</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>999</span><span style=color:#000;font-weight:700>),</span> <span style=color:#204a87;font-weight:700>static_cast</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Foo_t</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>999</span><span style=color:#000;font-weight:700>)};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// Results in int equivalent: {999, 999, 0, 0, 0}
</span></span></span></code></pre></div><p>If there are a hundred of elements then you have to write all of them down in the list.</p><p>You can, of course, initialize it in a loop but this sacrifices runtime performance.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// Runtime initialization
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>std</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Foo_t</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>5</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>array</span> <span style=color:#000;font-weight:700>{};</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>for</span> <span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>auto</span><span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#f57900>i</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000>array</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>static_cast</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Foo_t</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>999</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// Results in int equivalent: {999, 999, 999, 999, 999}
</span></span></span></code></pre></div><h2 id=generating-code-by-templates>Generating code by templates</h2><p>We can use recursive deduction of templates to generate our code. There is a limit that you can only do 1024 times of recursion but in my case it&rsquo;s enough.</p><p>The idea is to count the size to zero and use variadic argument to increase the number of arguments on each recursion. Finally the size of the array will be passed to the bottom and the variadic argument gets expanded.</p><p>It&rsquo;s a pretty simple trick.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#204a87;font-weight:700>template</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>std</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>size_t</span> <span style=color:#000>N</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>std</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>size_t</span> <span style=color:#000>M</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>typename</span> <span style=color:#000>T</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>typename</span><span style=color:#000;font-weight:700>...</span> <span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>ARR_IMPL</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>constexpr</span> <span style=color:#204a87;font-weight:700>auto</span> <span style=color:#000>arr</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ARR_IMPL</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>N</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>M</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>T</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>T</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>U</span><span style=color:#000;font-weight:700>...</span><span style=color:#ce5c00;font-weight:700>&gt;::</span><span style=color:#000>arr</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>template</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>std</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>size_t</span> <span style=color:#000>N</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>typename</span> <span style=color:#000>T</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>typename</span><span style=color:#000;font-weight:700>...</span> <span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>ARR_IMPL</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>N</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>T</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>U</span><span style=color:#000;font-weight:700>...</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>constexpr</span> <span style=color:#000>std</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>N</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>arr</span> <span style=color:#000;font-weight:700>{</span><span style=color:#204a87;font-weight:700>static_cast</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>999</span><span style=color:#000;font-weight:700>)...};</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>template</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>std</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>size_t</span> <span style=color:#000>N</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>typename</span> <span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>ARR</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>constexpr</span> <span style=color:#204a87;font-weight:700>auto</span> <span style=color:#000>arr</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ARR_IMPL</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>N</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>N</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>T</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;::</span><span style=color:#000>arr</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>constexpr</span> <span style=color:#204a87;font-weight:700>auto</span> <span style=color:#000>array1</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ARR</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>Foo_t</span><span style=color:#ce5c00;font-weight:700>&gt;::</span><span style=color:#000>arr</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>constexpr</span> <span style=color:#204a87;font-weight:700>auto</span> <span style=color:#000>array2</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ARR</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>Foo_t</span><span style=color:#ce5c00;font-weight:700>&gt;::</span><span style=color:#000>arr</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// array1 results in int equivalent: {999, 999, 999, 999, 999}
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// array2 results in int equivalent: {999, 999, 999, 999, 999, ...}
</span></span></span></code></pre></div></div></div><script src=https://peromage.github.io/js/mathjax.3.2.2.tex-svg.min.js></script><div class=bottombar><div class=bottombar-sticky><div class=icons><span class=icons-item><a href=https://github.com/peromage target=_blank><i class="fab fa-github"></i></a> </span><span class=icons-item><a href=https://www.linkedin.com/in/fangdeng/ target=_blank><i class="fab fa-linkedin fa-1x"></i></a> </span><span class=icons-item><a href=mailto:fang@elfang.com><i class="fas fa-envelope fa-1x"></i></a> </span><span class=icons-item><a href=/pub.txt><i class="fas fa-key fa-1x"></i></a></span></div><div class=footer><p>&copy; 2024 Fang Deng, <a href=https://peromage.github.io/license/>License</a><br><a href=/privacy title="Privacy notice">Privacy notice</a></p></div></div></div></body></html>
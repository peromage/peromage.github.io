<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en-us lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>My Common Windows VM Setup &#183;</title><meta name=description content="Interesting content."><meta name=keywords content="Interesting keywords."><link rel=stylesheet href=https://peromage.github.io/css/skeria.css><link rel=stylesheet href=https://peromage.github.io/css/font.awesome.6.1.2.all.min.css></head><body><div class=topbar><div class=topbar-sticky><a href=https://peromage.github.io/ style=text-decoration:none><h1>undefined behavior</h1></a><span class=lead>tb;dr - too boring; don&rsquo;t read</span>
<span class=topbar-nav><p><span class=topbar-nav-item><a href=https://peromage.github.io/>Recent</a>
</span><span class=topbar-nav-item><a href=https://peromage.github.io/posts>All Posts</a>
</span><span class=topbar-nav-item><a href=https://peromage.github.io/categories>Categories</a>
</span><span class=topbar-nav-item><a href=https://peromage.github.io/tags>Tags</a>
</span><span class=topbar-nav-item><a href=https://peromage.github.io/about>About</a>
</span><span class=topbar-nav-item><a href=https://peromage.github.io/search>Search</a></span></p></span></div></div><div class="content container"><div class=post><h1 class=post-title>My Common Windows VM Setup</h1><span class=post-date>Mar 13, 2022
&nbsp;&#183;&nbsp; 15 minute read
&nbsp;&#183;&nbsp;
<a class=label href=https://peromage.github.io/linux>linux</a></span><h2 id=before-starting>Before Starting</h2><p>This post mainly discusses VM setup for Windows since I&rsquo;ve been using Windows as a secondary OS for apps or games that cannot run on Linux.</p><p>This post discusses setup on Arch Linux.</p><p>This post assumes the CPU and motherboard support <code>VT-d</code> and <code>IOMMU</code> features. Detailed prerequisites can be found on <a href=https://wiki.archlinux.org/title/PCI_passthrough_via_OVMF>this page</a>.</p><h2 id=install-hypervisor>Install Hypervisor</h2><p>Follow Arch wiki to install and setup:</p><ol><li><a href=https://wiki.archlinux.org/title/QEMU>QEMU</a></li><li><a href=https://wiki.archlinux.org/title/libvirt>Libvirt</a></li><li><a href=https://wiki.archlinux.org/title/Virt-Manager>Virt-Manager</a></li><li><a href=https://wiki.archlinux.org/title/PCI_passthrough_via_OVMF>OVMF</a></li></ol><h2 id=install-windows-vm>Install Windows VM</h2><h3 id=before-installation>Before Installation</h3><p>Download the latest Windows 10 ISO from <a href=https://www.microsoft.com/en-ca/software-download/windows10ISO>Microsoft</a>. Windows 11 is buggy and requires Microsoft account login during installation, which sucks.</p><p>We also need to get <a href=https://github.com/virtio-win/virtio-win-pkg-scripts/blob/master/README.md>VirtIO</a> driver before installing Windows.</p><h3 id=during-installation>During Installation</h3><p>Then create a new VM with the following configuration before starting installation:</p><ul><li>Overview: Change <em>Firmware</em> to <code>UEFI</code>.</li><li>CPUs:<ul><li>Unselect <em>Copy host CPU configuration</em> and change <em>Model</em> to <code>host-passthrough</code>.</li><li>Select <em>Manually set CPU topology</em>. Change <em>Sockets</em> to <code>1</code>, <em>Cores</em> to <code>4</code>, <em>Threads</em> to <code>2</code> (Physical core <code>4</code> * threads for each core <code>2</code>).</li></ul></li><li>Disk: Change <em>Disk bus</em> to <code>VirtIO</code>.</li><li>NIC: Change <em>Device model</em> to <code>VirtIO</code>.</li><li>Display Spice: Use <em>Type</em> <code>Spice server</code>.</li><li>Video: Use <em>Model</em> <code>QXL</code>.</li></ul><p>During the installation, the Windows installer may not be able to find the disk because it doesn&rsquo;t have the driver (that&rsquo;s why you have to download it beforehand). Load the driver from the ISO and continue installation. This step should be trivial.</p><h4 id=optional-use-vhd--x--native-boot>Optional: Use VHD(X) Native Boot</h4><p>QCOW and raw format image files have decent performance. However, in most cases the guest Windows prefers to be installed on a real SSD drive to achieve maximum I/O. But you have experience installing Windows you would know that Windows creates several unnecessary partitions during installation. I don&rsquo;t want Windows to occupy the whole disk and create those clusters, especially on a portable SSD drive. I probably use the disk for other purposes and having those partitions is a really bad idea. It also looks ugly.</p><p>This VHD(X) native boot trick I have used it in <a href=/p/dual-booting-windows-vhd-and-native-linux-on-a-bios-gpt-pc/>dual-booting Windows and Linux</a> before.</p><p>To start, passthrough the SSD drive with <code>SATA</code> bus (don&rsquo;t use VirtIO for now). Then boot into Windows installation ISO and press <code>Shift+F10</code> to open a CMD window (Yes, you don&rsquo;t even need to start the installation process).</p><p>First we need to create the partitions. In the CMD window:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>&gt; diskpart
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># List all disks</span>
</span></span><span style=display:flex><span>DISKPART&gt; list disk
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Choose the SSD drive</span>
</span></span><span style=display:flex><span>DISKPART&gt; <span style=color:#204a87;font-weight:700>select</span> disk <span style=color:#0000cf;font-weight:700>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Make sure have a backup as this wipes out the whole disk</span>
</span></span><span style=display:flex><span>DISKPART&gt; clean
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Creat the partition table</span>
</span></span><span style=display:flex><span>DISKPART&gt; convert gpt
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># An EFI partition is necessary</span>
</span></span><span style=display:flex><span>DISKPART&gt; create partition efi <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>512</span>
</span></span><span style=display:flex><span>DISKPART&gt; <span style=color:#204a87;font-weight:700>select</span> partition <span style=color:#0000cf;font-weight:700>1</span>
</span></span><span style=display:flex><span>DISKPART&gt; format <span style=color:#000>fs</span><span style=color:#ce5c00;font-weight:700>=</span>fat quick
</span></span><span style=display:flex><span>DISKPART&gt; assign <span style=color:#000>letter</span><span style=color:#ce5c00;font-weight:700>=</span>E
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Assign the rest space for our main partition</span>
</span></span><span style=display:flex><span>DISKPART&gt; create partition primary
</span></span><span style=display:flex><span>DISKPART&gt; <span style=color:#204a87;font-weight:700>select</span> partition <span style=color:#0000cf;font-weight:700>2</span>
</span></span><span style=display:flex><span>DISKPART&gt; format <span style=color:#000>fs</span><span style=color:#ce5c00;font-weight:700>=</span>ntfs quick
</span></span><span style=display:flex><span>DISKPART&gt; assign <span style=color:#000>letter</span><span style=color:#ce5c00;font-weight:700>=</span>D
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Create a VHD file to host the Windows system files</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Note: Better use VHDX format as it has data corruption protection</span>
</span></span><span style=display:flex><span>DISKPART&gt; create vdisk <span style=color:#000>file</span><span style=color:#ce5c00;font-weight:700>=</span>f:<span style=color:#4e9a06>\w</span>in.vhdx <span style=color:#000>maximum</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>64000</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>=</span>fixed
</span></span><span style=display:flex><span>DISKPART&gt; <span style=color:#204a87;font-weight:700>select</span> vdisk <span style=color:#000>file</span><span style=color:#ce5c00;font-weight:700>=</span>f:<span style=color:#4e9a06>\w</span>in.vhdx
</span></span><span style=display:flex><span>DISKPART&gt; attach vdisk
</span></span><span style=display:flex><span>DISKPART&gt; convert gpt
</span></span><span style=display:flex><span>DISKPART&gt; create partition primary
</span></span><span style=display:flex><span>DISKPART&gt; format <span style=color:#000>fs</span><span style=color:#ce5c00;font-weight:700>=</span>ntfs quick
</span></span><span style=display:flex><span>DISKPART&gt; assign <span style=color:#000>letter</span><span style=color:#ce5c00;font-weight:700>=</span>H
</span></span><span style=display:flex><span>DISKPART&gt; <span style=color:#204a87>exit</span>
</span></span></code></pre></div><p>Now we have EFI partition assigned to <code>E:</code>, data partition assigned to <code>D:</code> and Windows VHD mounted at <code>H:</code>.</p><p>Then extract Windows files to <code>H:</code>, but before that we need to make sure select the correct version that we want to install.</p><p>Assume the installation medium is mounted at <code>G:</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>&gt; dism /get-wiminfo /wimfile<span style=color:#ce5c00;font-weight:700>=</span>g:<span style=color:#4e9a06>\s</span>ources<span style=color:#4e9a06>\i</span>nstall.wim
</span></span></code></pre></div><p>There would be a list of different versions that this installation medium has. For me, Windows 10 Pro for Workstations is at 10. Then I can use the following command to extract it to <code>H:</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>&gt; dism /apply-image /imagefile:g:<span style=color:#4e9a06>\s</span>ources<span style=color:#4e9a06>\i</span>nstall.wim /index:10 /applydir:h:<span style=color:#4e9a06>\
</span></span></span></code></pre></div><p>Lastly, fix the bootloader. Make sure install the bootloader files to the EFI partition.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>&gt; bcdboot h:<span style=color:#4e9a06>\W</span>indows /l en-us /s e: /f uefi
</span></span></code></pre></div><p>Reboot and finish Windows installation. Don&rsquo;t forget to switch the SSD bus to <code>VirtIO</code> after installing the driver.</p><h3 id=after-installation>After Installation</h3><p>Keep the <code>VirtIO</code> ISO in the CD ROM device when boot into Windows. Find <code>virtio-win-gt-x64.msi</code> and <code>virtio-win-guest-tools.exe</code> then install them both. Then power off VM.</p><p>Then configure VM:</p><ul><li>Add Hardware -> Channel -> Select <code>org.qemu.guest_agent.0</code> -> Finish</li></ul><p>Until here, the basic Windows VM setup is done.</p><h3 id=note>Note</h3><p>The video device doesn&rsquo;t support <code>VirtIO</code> <a href=https://wiki.archlinux.org/title/QEMU#virtio>on Windows</a> so we have to use <code>QXL</code> for now.</p><h2 id=passthrough-discrete-graphic-card>Passthrough: Discrete Graphic Card</h2><h3 id=identify-discrete-graphic-card>Identify Discrete Graphic Card</h3><p>In a terminal:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ lspci -nnk <span style=color:#000;font-weight:700>|</span> grep -A <span style=color:#0000cf;font-weight:700>3</span> -i nvidia
</span></span><span style=display:flex><span>01:00.0 VGA compatible controller <span style=color:#ce5c00;font-weight:700>[</span>0300<span style=color:#ce5c00;font-weight:700>]</span>: NVIDIA Corporation GM204 <span style=color:#ce5c00;font-weight:700>[</span>GeForce GTX 970<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>10de:13c2<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>(</span>rev a1<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    Subsystem: Gigabyte Technology Co., Ltd Device <span style=color:#ce5c00;font-weight:700>[</span>1458:367a<span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span>    Kernel driver in use: nouveau
</span></span><span style=display:flex><span>    Kernel modules: nouveau
</span></span><span style=display:flex><span>01:00.1 Audio device <span style=color:#ce5c00;font-weight:700>[</span>0403<span style=color:#ce5c00;font-weight:700>]</span>: NVIDIA Corporation GM204 High Definition Audio Controller <span style=color:#ce5c00;font-weight:700>[</span>10de:0fbb<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>(</span>rev a1<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    Subsystem: Gigabyte Technology Co., Ltd Device <span style=color:#ce5c00;font-weight:700>[</span>1458:367a<span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span>    Kernel driver in use: snd_hda_intel
</span></span><span style=display:flex><span>    Kernel modules: snd_hda_intel
</span></span></code></pre></div><p>Take a note of the device IDs. In this example I have a Nvidia GTX970 graphic card along with a audio controller. They belong to the same group (domain) you have to take them all.</p><p>In this case I got <code>10de:13c2</code> and <code>10de:0fbb</code>. These are the PCI devices that will be passed through to the VM. Other PCI devices can be passed too.</p><h3 id=add-kernel-modules>Add Kernel Modules</h3><p>Add following modules to <code>mkinitcpio.conf</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cfg data-lang=cfg><span style=display:flex><span><span style=color:#8f5902;font-style:italic># /etc/mkinitcpio.conf</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>MODULES</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>(vfio_pci vfio vfio_iommu_type1 vfio_virqfd)</span>
</span></span></code></pre></div><p>Then regenerate ramfs.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ sudo mkinitcpio -P
</span></span></code></pre></div><h3 id=add-kernel-parameters>Add Kernel Parameters</h3><p>Then we&rsquo;re going to enable IOMMU and prevent host Linux loading PCI devices that we want to passthrough to the VM.</p><p>The kernel parameter passing could be different depending on the bootloader you use. In this example, I use <code>systemd-boot</code>.</p><p>Edit the system entry. Add <code>intel_iommu=on</code> to the kernel parameter along with <code>vfio-pci.ids=10de:13c2,10de:0fbb</code> which contains the device IDs we got from the previous step.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cfg data-lang=cfg><span style=display:flex><span><span style=color:#8f5902;font-style:italic># /boot/loader/entries/arch.conf</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>options intel_iommu</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>on vfio-pci.ids=10de:13c2,10de:0fbb</span>
</span></span></code></pre></div><p>After reboot, verify IOMMU is enabled successfully via <code>dmesg</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ sudo dmesg <span style=color:#000;font-weight:700>|</span> grep -i -e DMAR -e IOMMU
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>    0.000000<span style=color:#ce5c00;font-weight:700>]</span> ACPI: DMAR 0x00000000BDCB1CB0 0000B8 <span style=color:#ce5c00;font-weight:700>(</span>v01 INTEL  BDW      <span style=color:#0000cf;font-weight:700>00000001</span> INTL 00000001<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>    0.000000<span style=color:#ce5c00;font-weight:700>]</span> Intel-IOMMU: enabled
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>    0.028879<span style=color:#ce5c00;font-weight:700>]</span> dmar: IOMMU 0: reg_base_addr fed90000 ver 1:0 cap c0000020660462 ecap f0101a
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>    0.028883<span style=color:#ce5c00;font-weight:700>]</span> dmar: IOMMU 1: reg_base_addr fed91000 ver 1:0 cap d2008c20660462 ecap f010da
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>    0.028950<span style=color:#ce5c00;font-weight:700>]</span> IOAPIC id <span style=color:#0000cf;font-weight:700>8</span> under DRHD base  0xfed91000 IOMMU <span style=color:#0000cf;font-weight:700>1</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>    0.536212<span style=color:#ce5c00;font-weight:700>]</span> DMAR: No ATSR found
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>    0.536229<span style=color:#ce5c00;font-weight:700>]</span> IOMMU <span style=color:#0000cf;font-weight:700>0</span> 0xfed90000: using Queued invalidation
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>    0.536230<span style=color:#ce5c00;font-weight:700>]</span> IOMMU <span style=color:#0000cf;font-weight:700>1</span> 0xfed91000: using Queued invalidation
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>    0.536231<span style=color:#ce5c00;font-weight:700>]</span> IOMMU: Setting RMRR:
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>    0.536241<span style=color:#ce5c00;font-weight:700>]</span> IOMMU: Setting identity map <span style=color:#204a87;font-weight:700>for</span> device 0000:00:02.0 <span style=color:#ce5c00;font-weight:700>[</span>0xbf000000 - 0xcf1fffff<span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>    0.537490<span style=color:#ce5c00;font-weight:700>]</span> IOMMU: Setting identity map <span style=color:#204a87;font-weight:700>for</span> device 0000:00:14.0 <span style=color:#ce5c00;font-weight:700>[</span>0xbdea8000 - 0xbdeb6fff<span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>    0.537512<span style=color:#ce5c00;font-weight:700>]</span> IOMMU: Setting identity map <span style=color:#204a87;font-weight:700>for</span> device 0000:00:1a.0 <span style=color:#ce5c00;font-weight:700>[</span>0xbdea8000 - 0xbdeb6fff<span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>    0.537530<span style=color:#ce5c00;font-weight:700>]</span> IOMMU: Setting identity map <span style=color:#204a87;font-weight:700>for</span> device 0000:00:1d.0 <span style=color:#ce5c00;font-weight:700>[</span>0xbdea8000 - 0xbdeb6fff<span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>    0.537543<span style=color:#ce5c00;font-weight:700>]</span> IOMMU: Prepare 0-16MiB unity mapping <span style=color:#204a87;font-weight:700>for</span> LPC
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>    0.537549<span style=color:#ce5c00;font-weight:700>]</span> IOMMU: Setting identity map <span style=color:#204a87;font-weight:700>for</span> device 0000:00:1f.0 <span style=color:#ce5c00;font-weight:700>[</span>0x0 - 0xffffff<span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>    2.182790<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>drm<span style=color:#ce5c00;font-weight:700>]</span> DMAR active, disabling use of stolen memory
</span></span></code></pre></div><p>Also, make sure VFIO driver is loaded.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ lspci -nnk <span style=color:#000;font-weight:700>|</span> grep -i -A <span style=color:#0000cf;font-weight:700>3</span> nvidia
</span></span><span style=display:flex><span>04:00.0 VGA compatible controller <span style=color:#ce5c00;font-weight:700>[</span>0300<span style=color:#ce5c00;font-weight:700>]</span>: NVIDIA Corporation GM204 <span style=color:#ce5c00;font-weight:700>[</span>GeForce GTX 970<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>10de:13c2<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>(</span>rev a1<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>	Subsystem: Gigabyte Technology Co., Ltd Device <span style=color:#ce5c00;font-weight:700>[</span>1458:367a<span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span>	Kernel driver in use: vfio-pci
</span></span><span style=display:flex><span>	Kernel modules: nouveau
</span></span><span style=display:flex><span>04:00.1 Audio device <span style=color:#ce5c00;font-weight:700>[</span>0403<span style=color:#ce5c00;font-weight:700>]</span>: NVIDIA Corporation GM204 High Definition Audio Controller <span style=color:#ce5c00;font-weight:700>[</span>10de:0fbb<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>(</span>rev a1<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>	Subsystem: Gigabyte Technology Co., Ltd Device <span style=color:#ce5c00;font-weight:700>[</span>1458:367a<span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span>	Kernel driver in use: vfio-pci
</span></span><span style=display:flex><span>	Kernel modules: snd_hda_intel
</span></span></code></pre></div><h3 id=passthrough-pci>Passthrough PCI</h3><p>Open VM settings and add the discrete graphic card as well as it&rsquo;s audio controller etc.</p><h3 id=install-drivers>Install Drivers</h3><p>Boot into Windows VM, now you should be able to install the graphic card driver.</p><h4 id=fix-error-code-43>Fix Error Code 43</h4><p>The latest Windows 10/11 should not have this problem. However, in any case if display adapter is malfunctioning and showing error code 43, use following workaround to avoid it.</p><p>Then open VM settings in XML view, add following content in the relevant sections to prevent Nvidia driver installer discovering the VM environment. Some sections may exist already so just append to them.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;domain&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;features&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;hyperv&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&lt;vendor_id</span> <span style=color:#c4a000>state=</span><span style=color:#4e9a06>&#39;on&#39;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#39;1234567890ab&#39;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;/hyperv&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;kvm&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&lt;hidden</span> <span style=color:#c4a000>state=</span><span style=color:#4e9a06>&#39;on&#39;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;/kvm&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;/features&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/domain&gt;</span>
</span></span></code></pre></div><h3 id=passthrough-enclosure-device>Passthrough Enclosure Device</h3><p>I&rsquo;m using Razer Core Chroma and Synapse is not available on Linux. In order to adjust RGB lights, pass the enclosure from USB device list.</p><h3 id=notes>Notes</h3><p>My setup is based on external GPU. If eGPU is powered on when laptop starts, somehow the kernel will be stuck. The eGPU has to be powered off and then powered on when system is up. Weird.</p><h2 id=passthrough-integrated-graphic-card-with-sr-iov>Passthrough: Integrated Graphic Card with SR-IOV</h2><p>I have a fairly new laptop with 12th gen Intel and Iris Xe graphic card but no discrete one. In this case Intel has provided a technology call <code>SR-IOV</code> which allows me to passthrough a part of my iGPU to the VM.</p><p>Note: <code>GVT-g</code> is <a href=https://wiki.archlinux.org/title/Intel_GVT-g#Prerequisite>only supported on 5th gen to 10th gen Intel CPUs</a>.</p><h3 id=install-kernel-module>Install Kernel Module</h3><p>I was following this <a href=https://github.com/intel/linux-intel-lts/issues/33>GitHub issue</a>. Basically an Intel customized <code>i915</code> kernel module is needed. However, thanks to @strongtz who has created an <a href=https://aur.archlinux.org/packages/i915-sriov-dkms-git>AUR package</a> so the Intel custom kernel is not required. All we need is this AUR package, which is awesome.</p><p>After installing the AUR package, update kernel parameters to enable IOMMU and SR-IOV virtual functions.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cfg data-lang=cfg><span style=display:flex><span><span style=color:#8f5902;font-style:italic># /boot/loader/entries/arch.conf</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>options intel_iommu</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>on iommu=pt i915.enable_guc=7</span>
</span></span></code></pre></div><p>Also add it to <code>mkinitcpio.conf</code></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cfg data-lang=cfg><span style=display:flex><span><span style=color:#8f5902;font-style:italic># /etc/mkinitcpio.conf</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>MODULES</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>(i915)</span>
</span></span></code></pre></div><p>Then reboot the system.</p><h3 id=create-virtual-functions>Create Virtual Functions</h3><p>If hardware supports and configuration is correct, the following <a href=https://github.com/intel/linux-intel-lts/issues/33#issuecomment-1328970093>kernel message</a> should be observed.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ sudo dmesg <span style=color:#000;font-weight:700>|</span> grep i915_virtualization_probe
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>    1.740640<span style=color:#ce5c00;font-weight:700>]</span> i915 0000:00:02.0: i915_virtualization_probe: entry
</span></span></code></pre></div><p>Then identify the iGPU by <code>lspci</code>. Usually Intel device starts with <code>00:02.x</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ lspci <span style=color:#000;font-weight:700>|</span> grep -P <span style=color:#4e9a06>&#34;VGA.*Intel&#34;</span>
</span></span><span style=display:flex><span>00:02.0 VGA compatible controller: Intel Corporation Alder Lake-P Integrated Graphics Controller <span style=color:#ce5c00;font-weight:700>(</span>rev 0c<span style=color:#ce5c00;font-weight:700>)</span>
</span></span></code></pre></div><p>Then we should be able to get the number of virtual functions allowed currently.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ cat /sys/devices/pci0000:00/0000:00:02.0/sriov_numvfs
</span></span><span style=display:flex><span><span style=color:#0000cf;font-weight:700>0</span>
</span></span></code></pre></div><p>To enable virtual functions, run this command as root user. I&rsquo;m creating one virtual function since I only have one VM that needs it. Maximal 7 virtual functions can be created.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ su
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># echo 1 &gt; /sys/devices/pci0000:00/0000:00:02.0/sriov_numvfs</span>
</span></span></code></pre></div><p>Finally check VGA device again, there should be an additional device created (the one starts with <code>00:02.1</code>).</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ lspci <span style=color:#000;font-weight:700>|</span> grep -P <span style=color:#4e9a06>&#34;VGA.*Intel&#34;</span>
</span></span><span style=display:flex><span>00:02.0 VGA compatible controller: Intel Corporation Alder Lake-P Integrated Graphics Controller <span style=color:#ce5c00;font-weight:700>(</span>rev 0c<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>00:02.1 VGA compatible controller: Intel Corporation Alder Lake-P Integrated Graphics Controller <span style=color:#ce5c00;font-weight:700>(</span>rev 0c<span style=color:#ce5c00;font-weight:700>)</span>
</span></span></code></pre></div><h3 id=install-intel-graphics-driver>Install Intel Graphics Driver</h3><p>Add the virtual PCI graphics adapter to VM (choose the shared on <code>00:02.1</code>) and boot up Windows. Be aware that we still the <code>QXL</code> video adapter this time.</p><p>Windows should now recognize a <strong>Display adapters/Microsoft Basic Display Adapter</strong> in <em>Device Manager</em> if everything is correct. Go to Intel website to get <a href=https://www.intel.ca/content/www/ca/en/download-center/home.html>the latest driver</a>.</p><p>Install it and reboot Windows. That adapter should now be recognized as <strong>Intel(R) Iris(R) Xe Graphics</strong>.</p><h2 id=install-looking-glass>Install Looking Glass</h2><p>Since I&rsquo;m setting this up on a laptop I don&rsquo;t have external display so <code>Looking Glass</code> must be used to redirect the VM display on the laptop screen.</p><h3 id=create-shared-memory>Create Shared Memory</h3><p>When the Windows VM is powered off, add the following content to the VM XML config (be aware of the hierarchy).</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;domain&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;device&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;shmem</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#39;looking-glass&#39;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&lt;model</span> <span style=color:#c4a000>type=</span><span style=color:#4e9a06>&#39;ivshmem-plain&#39;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&lt;size</span> <span style=color:#c4a000>unit=</span><span style=color:#4e9a06>&#39;M&#39;</span><span style=color:#204a87;font-weight:700>&gt;</span>64<span style=color:#204a87;font-weight:700>&lt;/size&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;/shmem&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;/device&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/domain&gt;</span>
</span></span></code></pre></div><p>The size of shared memory depends on the <a href=https://looking-glass.io/docs/B5.0.1/install/#determining-memory>maximal resolution</a> that Windows VM will be using. Simply this formula can be used. The result must be rounded up to the nearest power of 2.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>total bytes = width x height x 4 x 2 / 1024 / 1024 + 10
</span></span></code></pre></div><p>For example my Windows VM can setup maximal 2560x1600 so it would be <em>2560 x 1600 x 4 x 2 / 1024 / 1024 + 10 = 41.25</em>. Then round it up to <strong>64</strong>.</p><p>After that, create a temp file config. The user name must match the user that is being used.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cfg data-lang=cfg><span style=display:flex><span><span style=color:#8f5902;font-style:italic># /etc/tmpfiles.d/10-looking-glass.conf</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#Type Path                   Mode UID  GID Age Argument</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>f     /dev/shm/looking-glass 0660 user kvm -</span>
</span></span></code></pre></div><p>Create the temp file for the first time (it will be created automatically after reboot).</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ sudo systemd-tmpfiles --create /etc/tmpfiles.d/10-looking-glass.conf
</span></span></code></pre></div><h3 id=install-host-service>Install Host Service</h3><p>Download and install Looking Glass <a href=https://looking-glass.io/downloads>service installer</a> in Windows. Note that Windows is the host in Looking Glass&rsquo;s context (Linux is the client that reads output from Windows VM).</p><p>Additionally, <code>IVSHMEM</code> <a href=https://looking-glass.io/docs/B5.0.1/install/#installing-the-ivshmem-driver>driver</a> is also needed so that Looking Glass service can shared the display via shared memory. It can be downloaded from <a href=https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/upstream-virtio/>RedHat</a>.</p><p>Then go to <em>Device Manager</em> and find <strong>System Devices/PCI standard RAM Controller</strong>. Update its driver with the downloaded <code>IVSHMEM</code> driver.</p><h3 id=solve-display-adapter-error-code-43>Solve Display Adapter Error Code 43</h3><p>Similarly I got the same error code as the passthrough for discrete graphic card. To solve it, add the following content to the VM config XML.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;domain&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;features&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;hyperv&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&lt;vendor_id</span> <span style=color:#c4a000>state=</span><span style=color:#4e9a06>&#39;on&#39;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#39;1234567890ab&#39;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;/hyperv&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;kvm&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&lt;hidden</span> <span style=color:#c4a000>state=</span><span style=color:#4e9a06>&#39;on&#39;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;/kvm&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;/features&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/domain&gt;</span>
</span></span></code></pre></div><h3 id=create-a-dummy-display>Create a Dummy Display</h3><p>Looking Glass mirrors display output so a display monitor must be connected to the eGPU&rsquo;s output. If you don&rsquo;t have a dummy HDMI dongle, a fake display device can be installed.</p><p>Download the <a href=https://github.com/ge9/IddSampleDriver>IddSampleDriver</a> from it&rsquo;s release page.</p><ul><li>Extract all content to <code>C:\IddSampleDriver</code> (Important since the path of config file is hard-coded).</li><li>Run <code>C:\installCert.bat</code> with Administrator privilege.</li><li>Install display driver: <em>Device Manager</em> -> <em>Add legacy haradware</em> -> <em>Advanced install</em> -> <em>Display adapter</em> -> <em>Browse driver on the disk</em> -> <em>Choose the inf file in the extracted directory</em>.</li><li>Restart Windows.</li></ul><h3 id=finish-up>Finish up</h3><p>Now get the same version of <a href=https://looking-glass.io/downloads>Looking Glass client</a> (important). Compile and run. The VM should be running smoothly with graphic acceleration.</p><h2 id=pinned-cpu-cores>Pinned CPU Cores</h2><p>To reduce latency, I prefer manually allocating CPU cores for both host and guest. One thing needs to mention is this doesn&rsquo;t prevent host process from running on the pinned cores. If the cores are expected to be used by VM only, consider <a href=https://wiki.archlinux.org/title/PCI_passthrough_via_OVMF#Isolating_pinned_CPUs>isolate pinned cores</a>.</p><p><strong>Note</strong>: <em>I&rsquo;ve noticed some sudden freeze if CPU cores are pinned while having some loads on Linux host side. Removing pinning and letting hypervisor decide itself seems to work fine, and the performance wise does not have too much difference. I don&rsquo;t usually pin cores now unless it&rsquo;s necessary.</em></p><p>First find out how many cores the CPU has.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ lscpu -e
</span></span><span style=display:flex><span>CPU NODE SOCKET CORE L1d:L1i:L2:L3 ONLINE    MAXMHZ   MINMHZ       MHZ
</span></span><span style=display:flex><span>  <span style=color:#0000cf;font-weight:700>0</span>    <span style=color:#0000cf;font-weight:700>0</span>      <span style=color:#0000cf;font-weight:700>0</span>    <span style=color:#0000cf;font-weight:700>0</span> 0:0:0:0          yes 4400.0000 400.0000  594.1430
</span></span><span style=display:flex><span>  <span style=color:#0000cf;font-weight:700>1</span>    <span style=color:#0000cf;font-weight:700>0</span>      <span style=color:#0000cf;font-weight:700>0</span>    <span style=color:#0000cf;font-weight:700>0</span> 0:0:0:0          yes 4400.0000 400.0000  987.0030
</span></span><span style=display:flex><span>  <span style=color:#0000cf;font-weight:700>2</span>    <span style=color:#0000cf;font-weight:700>0</span>      <span style=color:#0000cf;font-weight:700>0</span>    <span style=color:#0000cf;font-weight:700>1</span> 4:4:1:0          yes 4400.0000 400.0000 1144.1160
</span></span><span style=display:flex><span>  <span style=color:#0000cf;font-weight:700>3</span>    <span style=color:#0000cf;font-weight:700>0</span>      <span style=color:#0000cf;font-weight:700>0</span>    <span style=color:#0000cf;font-weight:700>1</span> 4:4:1:0          yes 4400.0000 400.0000 2100.0000
</span></span><span style=display:flex><span>  <span style=color:#0000cf;font-weight:700>4</span>    <span style=color:#0000cf;font-weight:700>0</span>      <span style=color:#0000cf;font-weight:700>0</span>    <span style=color:#0000cf;font-weight:700>2</span> 8:8:2:0          yes 4400.0000 400.0000  944.5790
</span></span><span style=display:flex><span>  <span style=color:#0000cf;font-weight:700>5</span>    <span style=color:#0000cf;font-weight:700>0</span>      <span style=color:#0000cf;font-weight:700>0</span>    <span style=color:#0000cf;font-weight:700>2</span> 8:8:2:0          yes 4400.0000 400.0000  975.3940
</span></span><span style=display:flex><span>  <span style=color:#0000cf;font-weight:700>6</span>    <span style=color:#0000cf;font-weight:700>0</span>      <span style=color:#0000cf;font-weight:700>0</span>    <span style=color:#0000cf;font-weight:700>3</span> 12:12:3:0        yes 4400.0000 400.0000 1116.9910
</span></span><span style=display:flex><span>  <span style=color:#0000cf;font-weight:700>7</span>    <span style=color:#0000cf;font-weight:700>0</span>      <span style=color:#0000cf;font-weight:700>0</span>    <span style=color:#0000cf;font-weight:700>3</span> 12:12:3:0        yes 4400.0000 400.0000  829.3560
</span></span><span style=display:flex><span>  <span style=color:#0000cf;font-weight:700>8</span>    <span style=color:#0000cf;font-weight:700>0</span>      <span style=color:#0000cf;font-weight:700>0</span>    <span style=color:#0000cf;font-weight:700>4</span> 16:16:4:0        yes 3300.0000 400.0000 1250.2290
</span></span><span style=display:flex><span>  <span style=color:#0000cf;font-weight:700>9</span>    <span style=color:#0000cf;font-weight:700>0</span>      <span style=color:#0000cf;font-weight:700>0</span>    <span style=color:#0000cf;font-weight:700>5</span> 17:17:4:0        yes 3300.0000 400.0000 1150.0020
</span></span><span style=display:flex><span> <span style=color:#0000cf;font-weight:700>10</span>    <span style=color:#0000cf;font-weight:700>0</span>      <span style=color:#0000cf;font-weight:700>0</span>    <span style=color:#0000cf;font-weight:700>6</span> 18:18:4:0        yes 3300.0000 400.0000 1208.8120
</span></span><span style=display:flex><span> <span style=color:#0000cf;font-weight:700>11</span>    <span style=color:#0000cf;font-weight:700>0</span>      <span style=color:#0000cf;font-weight:700>0</span>    <span style=color:#0000cf;font-weight:700>7</span> 19:19:4:0        yes 3300.0000 400.0000 1016.9800
</span></span><span style=display:flex><span> <span style=color:#0000cf;font-weight:700>12</span>    <span style=color:#0000cf;font-weight:700>0</span>      <span style=color:#0000cf;font-weight:700>0</span>    <span style=color:#0000cf;font-weight:700>8</span> 20:20:5:0        yes 3300.0000 400.0000 1226.8660
</span></span><span style=display:flex><span> <span style=color:#0000cf;font-weight:700>13</span>    <span style=color:#0000cf;font-weight:700>0</span>      <span style=color:#0000cf;font-weight:700>0</span>    <span style=color:#0000cf;font-weight:700>9</span> 21:21:5:0        yes 3300.0000 400.0000 1046.9780
</span></span><span style=display:flex><span> <span style=color:#0000cf;font-weight:700>14</span>    <span style=color:#0000cf;font-weight:700>0</span>      <span style=color:#0000cf;font-weight:700>0</span>   <span style=color:#0000cf;font-weight:700>10</span> 22:22:5:0        yes 3300.0000 400.0000 1068.5780
</span></span><span style=display:flex><span> <span style=color:#0000cf;font-weight:700>15</span>    <span style=color:#0000cf;font-weight:700>0</span>      <span style=color:#0000cf;font-weight:700>0</span>   <span style=color:#0000cf;font-weight:700>11</span> 23:23:5:0        yes 3300.0000 400.0000 2100.0000
</span></span></code></pre></div><p>My CPU is Intel 1240P. It has 4 performance cores and 8 efficiency cores. In my setup, I keep core 0 for host and pass the rest 3 performance cores and 2 efficiency cores to the guest (for 8 threads).</p><p>Add this configuration to the VM.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;vcpu</span> <span style=color:#c4a000>placement=</span><span style=color:#4e9a06>&#34;static&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>8<span style=color:#204a87;font-weight:700>&lt;/vcpu&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;iothreads&gt;</span>1<span style=color:#204a87;font-weight:700>&lt;/iothreads&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;cputune&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;vcpupin</span> <span style=color:#c4a000>vcpu=</span><span style=color:#4e9a06>&#34;0&#34;</span> <span style=color:#c4a000>cpuset=</span><span style=color:#4e9a06>&#34;2&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;vcpupin</span> <span style=color:#c4a000>vcpu=</span><span style=color:#4e9a06>&#34;1&#34;</span> <span style=color:#c4a000>cpuset=</span><span style=color:#4e9a06>&#34;3&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;vcpupin</span> <span style=color:#c4a000>vcpu=</span><span style=color:#4e9a06>&#34;2&#34;</span> <span style=color:#c4a000>cpuset=</span><span style=color:#4e9a06>&#34;4&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;vcpupin</span> <span style=color:#c4a000>vcpu=</span><span style=color:#4e9a06>&#34;3&#34;</span> <span style=color:#c4a000>cpuset=</span><span style=color:#4e9a06>&#34;5&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;vcpupin</span> <span style=color:#c4a000>vcpu=</span><span style=color:#4e9a06>&#34;4&#34;</span> <span style=color:#c4a000>cpuset=</span><span style=color:#4e9a06>&#34;6&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;vcpupin</span> <span style=color:#c4a000>vcpu=</span><span style=color:#4e9a06>&#34;5&#34;</span> <span style=color:#c4a000>cpuset=</span><span style=color:#4e9a06>&#34;7&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;vcpupin</span> <span style=color:#c4a000>vcpu=</span><span style=color:#4e9a06>&#34;6&#34;</span> <span style=color:#c4a000>cpuset=</span><span style=color:#4e9a06>&#34;8&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;vcpupin</span> <span style=color:#c4a000>vcpu=</span><span style=color:#4e9a06>&#34;7&#34;</span> <span style=color:#c4a000>cpuset=</span><span style=color:#4e9a06>&#34;9&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;emulatorpin</span> <span style=color:#c4a000>cpuset=</span><span style=color:#4e9a06>&#34;0-1&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;iothreadpin</span> <span style=color:#c4a000>iothread=</span><span style=color:#4e9a06>&#34;1&#34;</span> <span style=color:#c4a000>cpuset=</span><span style=color:#4e9a06>&#34;0-1&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/cputune&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;cpu</span> <span style=color:#c4a000>mode=</span><span style=color:#4e9a06>&#34;host-passthrough&#34;</span> <span style=color:#c4a000>check=</span><span style=color:#4e9a06>&#34;none&#34;</span> <span style=color:#c4a000>migratable=</span><span style=color:#4e9a06>&#34;on&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;topology</span> <span style=color:#c4a000>sockets=</span><span style=color:#4e9a06>&#34;1&#34;</span> <span style=color:#c4a000>dies=</span><span style=color:#4e9a06>&#34;1&#34;</span> <span style=color:#c4a000>cores=</span><span style=color:#4e9a06>&#34;4&#34;</span> <span style=color:#c4a000>threads=</span><span style=color:#4e9a06>&#34;2&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/cpu&gt;</span>
</span></span></code></pre></div><h2 id=enable-msi--message-signaled-based-interrupts>Enable MSI(Message Signaled-Based Interrupts)</h2><p>Most likely by default the Windows VM will use <em>Line-Base Interrupts</em> which usually causes audio distortion and slow down the performance. In this case, we need to enable MSI.</p><p>To check what type of interrupts the graphic card is using at the moment, run this command as root while VM is running. <code>04:00</code> is my graphic card bus ID.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ sudo lspci -vs 04:00 <span style=color:#000;font-weight:700>|</span> grep <span style=color:#4e9a06>&#39;MSI:&#39;</span>
</span></span><span style=display:flex><span>Capabilities: <span style=color:#ce5c00;font-weight:700>[</span>68<span style=color:#ce5c00;font-weight:700>]</span> MSI: Enable+ <span style=color:#000>Count</span><span style=color:#ce5c00;font-weight:700>=</span>1/1 Maskable- 64bit+
</span></span><span style=display:flex><span>Capabilities: <span style=color:#ce5c00;font-weight:700>[</span>68<span style=color:#ce5c00;font-weight:700>]</span> MSI: Enable+ <span style=color:#000>Count</span><span style=color:#ce5c00;font-weight:700>=</span>1/1 Maskable- 64bit+
</span></span></code></pre></div><p>A <code>-</code> after Enable <a href=https://wiki.archlinux.org/title/PCI_passthrough_via_OVMF#Slowed_down_audio_pumped_through_HDMI_on_the_video_card>means</a> MSI is supported, but not used by the virtual machine, while a <code>+</code> says that the virtual machine is using it. Since I have enabled it already the result shows <code>+</code> which is expected.</p><p>Then go back to the Windows VM and <a href=https://forums.guru3d.com/threads/windows-line-based-vs-message-signaled-based-interrupts-msi-tool.378044/>enable</a> MSI.</p><p>In <em>Device Manager</em>, find the graphic card: <em>View</em> -> <em>Resource by type</em> -> <em>Interrupt request (IRQ)</em> -> <em>(PCI) 0xFFFFFFD0 (-48) NVIDIA GeForce GTX 970</em>.</p><p>The value in the parenthesis also reflects the interrupt status. Positive value means Line-Based Interrupt mode and negative value means Message Signaled-Based mode. As my card has already been tweaked, it is negative value here.</p><p>To enable MSI: open the property of <em>(PCI) 0xFFFFFFD0 (-48) NVIDIA GeForce GTX 970</em> -> <em>Details</em> -> in the <em>Property</em> dropdown menu select <em>Device instance path</em>.</p><p>Note down the value of this property. In my case it is <code>PCI\VEN_10DE&amp;DEV_13C2&amp;SUBSYS_367A1458&amp;REV_A1\4&amp;123CFF10&amp;0&amp;000C</code>.</p><p>Then open <em>Registry Editor</em> and find out the device entry. It should be a subkey of <code>Computer\HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Enum</code>. E.g. <code>PCI\VEN_10DE&amp;DEV_13C2&amp;SUBSYS_367A1458&amp;REV_A1\4&amp;123cff10&amp;0&amp;000C\Device Parameters\Interrupt Management</code>. From there, create a new key named <code>MessageSignaledInterruptProperties</code> as well as a DWORD value <code>MSISupported</code> with data <code>1</code> (Change the data if it exists already).</p><p>In addition to the graphic card itself, the audio device on the card also needs to be tweaked. Audio device should have the same vendor ID and a different device ID which can be obtained from <a href=#identify-discrete-graphic-card>the previous section</a>. Normally it should be adjacent to the card. For example <code>Computer\HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Enum\PCI\VEN_10DE&amp;DEV_0FBB&amp;SUBSYS_367A1458&amp;REV_A1\4&amp;336a283&amp;0&amp;0010\Device Parameters\Interrupt Management\MessageSignaledInterruptProperties</code>. Similarly update the data to <code>1</code>.</p><p>Now reboot Windows and check if graphic card works from <em>Device Manager</em> as well as the IRQ value which shows MSI status.</p><h2 id=huge-memory-pages>Huge Memory Pages</h2><p>Normally, I don&rsquo;t think I really need this setup. In any case if it&rsquo;s needed, I&rsquo;ll use <a href=https://wiki.archlinux.org/title/PCI_passthrough_via_OVMF#Static_huge_pages>static huge pages</a>. With static huge pages, a portion of memory will be allocated for VM and can&rsquo;t be used by host.</p><p>To verify is CPU supports it.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ grep pdpe1gb /proc/cpuinfo
</span></span></code></pre></div><p>Add kernel parameters.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cfg data-lang=cfg><span style=display:flex><span><span style=color:#8f5902;font-style:italic># /boot/loader/entries/arch.conf</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>options default_hugepagesz</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>1G hugepagesz=1G hugepages=X</span>
</span></span></code></pre></div><p>Add this configuration to the VM.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;memoryBacking&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;hugepages/&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/memoryBacking&gt;</span>
</span></span></code></pre></div><h2 id=audio-redirection>Audio Redirection</h2><p>By default the audio is output from HDMI through the graphic card (if it supports). In order to use the laptop speaker, we need to install a special virtual audio device called <a href=https://github.com/duncanthrax/scream>scream</a>.</p><p>On Arch, installing from <a href=https://aur.archlinux.org/packages/scream>AUR</a> is the most convenient way. Then start the service by receiving audio through network. In this case, <code>virbr0</code> is my NAT adapter.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ scream -i virbr0
</span></span></code></pre></div><p>On Windows, download and install the <a href=https://github.com/duncanthrax/scream/releases>driver</a> then switch output device to scream. It should work perfectly out of the box.</p><h3 id=alternative-way-to-stream-audio>Alternative Way to Stream Audio</h3><p><code>scream</code> also supports stream through shared memory but it requires additional setup. Checkout it&rsquo;s readme as it shows how to set it up. Usually, I don&rsquo;t feel like I really need it. If there is obvious latency, this should a backup plan.</p><h2 id=references>References</h2><ul><li><a href=https://wiki.archlinux.org/title/QEMU>ArchWiki QEMU</a></li><li><a href=https://wiki.archlinux.org/title/PCI_passthrough_via_OVMF>ArchWiki OVMF</a></li><li><a href=https://wiki.archlinux.org/title/Intel_GVT-g>Intel GVT-g</a></li><li><a href=https://looking-glass.io/>Looking Glass</a></li><li><a href=https://github.com/virtio-win/virtio-win-pkg-scripts/blob/master/README.md>Virtio driver</a></li><li><a href=https://github.com/intel/linux-intel-lts/issues/33>SR-IOV: mainlining?</a></li><li><a href=https://github.com/strongtz/i915-sriov-dkms>strongtz/i915-sriov-dkms</a></li><li><a href=https://github.com/ge9/IddSampleDriver>ge9/IddSampleDriver</a></li><li><a href=https://www.reddit.com/r/VFIO/comments/wj6zhz/gpu_passthrough_looking_glass_no_external/>GPU Passthrough + Looking Glass + no external monitor/dummy</a></li><li><a href=https://forums.guru3d.com/threads/windows-line-based-vs-message-signaled-based-interrupts-msi-tool.378044/>Windows: Line-Based vs. Message Signaled-Based Interrupts. MSI tool.</a></li></ul></div></div><script src=https://peromage.github.io/js/mathjax.3.2.2.tex-svg.min.js></script><div class=bottombar><div class=bottombar-sticky><div class=icons><span class=icons-item><a href=https://github.com/peromage target=_blank><i class="fab fa-github"></i></a> </span><span class=icons-item><a href=https://www.linkedin.com/in/fangdeng/ target=_blank><i class="fab fa-linkedin fa-1x"></i></a> </span><span class=icons-item><a href=mailto:fang@elfang.com><i class="fas fa-envelope fa-1x"></i></a> </span><span class=icons-item><a href=/me.pub><i class="fas fa-key fa-1x"></i></a></span></div><div class=footer><p>&copy; 2025 , <a href=https://peromage.github.io/license/>License</a><br><a href=/privacy title="Privacy notice">Privacy notice</a></p></div></div></div></body></html>
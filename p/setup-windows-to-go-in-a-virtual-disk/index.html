<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en-us lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>Setup Windows To Go in a Virtual Disk &#183; </title><meta name=description content="Interesting content."><meta name=keywords content="Interesting keywords."><link rel=stylesheet href=https://peromage.github.io/css/skeria.css><link rel=stylesheet href=https://peromage.github.io/css/font.awesome.6.1.2.all.min.css></head><body><div class=topbar><div class=topbar-sticky><a href=https://peromage.github.io/ style=text-decoration:none><h1>undefined behavior</h1></a><span class=lead>tb;dr - too boring; don&rsquo;t read</span>
<span class=topbar-nav><p><span class=topbar-nav-item><a href=https://peromage.github.io/>Recent</a>
</span><span class=topbar-nav-item><a href=https://peromage.github.io/posts>All Posts</a>
</span><span class=topbar-nav-item><a href=https://peromage.github.io/categories>Categories</a>
</span><span class=topbar-nav-item><a href=https://peromage.github.io/tags>Tags</a>
</span><span class=topbar-nav-item><a href=https://peromage.github.io/about>About</a>
</span><span class=topbar-nav-item><a href=https://peromage.github.io/search>Search</a></span></p></span></div></div><div class="content container"><div class=post><h1 class=post-title>Setup Windows To Go in a Virtual Disk</h1><span class=post-date>Mar 13, 2024
&nbsp;&#183;&nbsp; 7 minute read
&nbsp;&#183;&nbsp;
<a class=label href=https://peromage.github.io/linux>linux</a></span><h2 id=ramble>Ramble</h2><p>It looks like I had a lot stories about this Windows boot setup. I figure this post would be the last one I write about it since this is the most commonly used case I have so far.</p><p>So I got a Steam Deck last year. It&rsquo;s pretty handy to use it as a mini PC in case I don&rsquo;t have one in hands. However, there are still things exclusive on Windows but I don&rsquo;t want to mess up with the internal SSD to dual-boot just for this temporary need.</p><p>One solution is to install Windows on a micro SD card. However, Windows installer does not allow you to do so because the micro SD card is recognized as a removable device. And also the Windows To Go feature has been <a href=https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-10/deployment/windows-to-go/windows-to-go-overview>removed</a> in Windows 10, which means you can&rsquo;t use the official tool to create a To Go workspace.</p><p>Regardless what&rsquo;s been said in that article Windows still actually supports this To Go feature. Even with Windows 11. One solution exists out there is to use <a href=https://rufus.ie>Rufus</a> to write the system image to a removable flash drive. After some experiments I was not satisfied with it. Firstly, it splits the flash into multiple partitions and Windows system files are exposed whenever you plug the card in a different machine. It makes hard to re-purpose the card without re-formatting it. Secondly, Rufus enables encryption which makes it even worse for a flash device (I know this is enforced by Windows 11 but it can be disabled).</p><p>The ultimate solution came to my mind is booting Windows from the VHD/VHDX. I&rsquo;ve done this many times in the past and it worked very well. However, when it is booting from a removable flash drive Windows installation can&rsquo;t pass the initialization stage saying Windows cannot be configured on this hardware. Even <code>Shift+F10</code> and run <code>oobems</code> will be stuck forever.</p><p>After many experiments I finally figured out a way to achieve this purpose.</p><h2 id=things-needed>Things Needed</h2><p>Make sure these things are ready before proceeding to the next step.</p><ul><li>A flash drive</li><li>A virtual machine with at least 64GiB disk space</li><li><a href=https://www.ventoy.net/en/index.html>Ventoy</a></li><li><a href=https://www.ventoy.net/en/plugin_vhdboot.html>Ventoy VHD boot plugin</a></li><li>A Windows 10/11 ISO image</li></ul><h2 id=tl-dr>TL;DR</h2><ol><li>Boot from the Windows ISO in the VM.</li><li>In the installer welcome window, press <code>Shift+F10</code> to open a command prompt.</li><li>Follow all the commands in <a href=#prepare-the-windows-image>Prepare the Windows Image</a> to get vdisk set up.</li><li>Restart the VM to finish the installation and shut it down after booting into the desktop.</li><li>Install Ventoy on the flash drive.</li><li>Format the data partition of the flash drive with file system <code>NTFS</code>.</li><li>Copy the VHD boot plugin of Ventoy to the partition just formatted, which is <code>/ventoy/ventoy_vhdboot.img</code>.</li><li>Passthrough the flash drive to the VM and boot the VM from the installation ISO. Then follow commands in <a href=#copy-the-prepared-windows-image>Copy the Prepared Windows Image</a> to copy the vdisk to the flash drive.</li></ol><h2 id=reminder-if-current-host-is-windows>Reminder - If Current Host is Windows</h2><p>I assume we don&rsquo;t have Windows environment. However, if you do, all those preparation steps mentioned below can be done on a bare metal Windows machine with Hyper-V enabled.</p><p>There are some slight differences, where</p><ol><li>In <a href=#prepare-the-windows-image>Prepare the Windows Image</a>, instead of creating one vdisk inside of the VM, create two on the host. Vdisk A is for EFI partition and vdisk B is for the Windows installation.</li><li>In <a href=#boot-into-windows-for-the-first-time>Boot into Windows for the First Time</a>, Attach two vdisks to a Hyper-V instance and follow the instruction.</li><li>In <a href=#prepare-a-bootable-drive>Prepare a Bootable Drive</a>, follow the instructions.</li><li>In <a href=#copy-the-prepared-windows-image>Copy the Prepared Windows Image</a>, instead of copying inside of the VM, copy the vdisk B directly on the host.</li></ol><h2 id=prepare-the-windows-image>Prepare the Windows Image</h2><p>Boot from the Windows ISO in the VM. After choosing the keyboard layout don&rsquo;t start the installation wizard. Instead press <code>Shift+F10</code> to open a command line prompt.</p><p>We need to partition the VM&rsquo;s disk so that we can start the installed Windows inside of.</p><p>Here are the commands used in the prompt.</p><p></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>&gt; diskpart
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Find out and select the VM&#39;s disk</span>
</span></span><span style=display:flex><span>DISKPART&gt; list disk
</span></span><span style=display:flex><span>DISKPART&gt; <span style=color:#204a87;font-weight:700>select</span> disk <span style=color:#0000cf;font-weight:700>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Initialize it</span>
</span></span><span style=display:flex><span>DISKPART&gt; clean
</span></span><span style=display:flex><span>DISKPART&gt; convert gpt
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Create the EFI partition</span>
</span></span><span style=display:flex><span>DISKPART&gt; create partition efi <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>512</span>
</span></span><span style=display:flex><span>DISKPART&gt; <span style=color:#204a87;font-weight:700>select</span> partition <span style=color:#0000cf;font-weight:700>1</span>
</span></span><span style=display:flex><span>DISKPART&gt; format <span style=color:#000>fs</span><span style=color:#ce5c00;font-weight:700>=</span>fat quick
</span></span><span style=display:flex><span>DISKPART&gt; assign <span style=color:#000>letter</span><span style=color:#ce5c00;font-weight:700>=</span>E
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Create the partition where Windows will be installed into with the rest of the space</span>
</span></span><span style=display:flex><span>DISKPART&gt; create partition primary
</span></span><span style=display:flex><span>DISKPART&gt; <span style=color:#204a87;font-weight:700>select</span> partition <span style=color:#0000cf;font-weight:700>2</span>
</span></span><span style=display:flex><span>DISKPART&gt; format <span style=color:#000>fs</span><span style=color:#ce5c00;font-weight:700>=</span>ntfs quick
</span></span><span style=display:flex><span>DISKPART&gt; assign <span style=color:#000>letter</span><span style=color:#ce5c00;font-weight:700>=</span>D
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Create a VHD file to host the Windows system files</span>
</span></span><span style=display:flex><span>DISKPART&gt; create vdisk <span style=color:#000>file</span><span style=color:#ce5c00;font-weight:700>=</span>d:<span style=color:#4e9a06>\w</span>in.vhdx <span style=color:#000>maximum</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>60000</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>=</span>expandable
</span></span><span style=display:flex><span>DISKPART&gt; <span style=color:#204a87;font-weight:700>select</span> vdisk <span style=color:#000>file</span><span style=color:#ce5c00;font-weight:700>=</span>d:<span style=color:#4e9a06>\w</span>in.vhdx
</span></span><span style=display:flex><span>DISKPART&gt; attach vdisk
</span></span><span style=display:flex><span>DISKPART&gt; convert gpt
</span></span><span style=display:flex><span>DISKPART&gt; create partition primary
</span></span><span style=display:flex><span>DISKPART&gt; format <span style=color:#000>fs</span><span style=color:#ce5c00;font-weight:700>=</span>ntfs quick
</span></span><span style=display:flex><span>DISKPART&gt; assign <span style=color:#000>letter</span><span style=color:#ce5c00;font-weight:700>=</span>V
</span></span><span style=display:flex><span>DISKPART&gt; <span style=color:#204a87>exit</span>
</span></span></code></pre></div><p>Eventually we have the following volumes setup:</p><ul><li><code>C:</code>: DVD drive (mounted by default, can vary)</li><li><code>E:</code>: VM EFI partition</li><li><code>D:</code>: VM data partition (where vdisk resides)</li><li><code>V:</code>: Windows partition</li></ul><p>60GB size should be far enough for a fresh new Windows installation. And the vdisk type can be changed to <code>fixed</code> if it needs to be pre-allocated but the process time could be lengthy. The reason that I use <code>vhdx</code> instead of <code>vhd</code> is because <code>vhdx</code> provides better data corruption protection and it supports differential disks which can be pretty handy later on.</p><p>Next is to confirm the index of the desired Windows version in this ISO.</p><p>NOTE: Only Windows Pro and above support Windows To Go.</p><p></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>&gt; dism /get-wiminfo /wimfile:c:<span style=color:#4e9a06>\s</span>ources<span style=color:#4e9a06>\i</span>nstall.wim
</span></span></code></pre></div><p>Then extract the system files. Assuming the Pro version index is <code>6</code>.</p><p></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>&gt; dism /apply-image /imagefile:g:<span style=color:#4e9a06>\s</span>ources<span style=color:#4e9a06>\i</span>nstall.wim /index:10 /applydir:h:<span style=color:#4e9a06>\
</span></span></span></code></pre></div><p>Lastly build the boot loader so that we can boot inside the VM.</p><p></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>&gt; bcdboot v:<span style=color:#4e9a06>\W</span>indows /l en-us /s e: /f uefi
</span></span></code></pre></div><p>At this point the Windows system image is mostly prepared. Now reboot the VM.</p><h2 id=boot-into-windows-for-the-first-time>Boot into Windows for the First Time</h2><p>We need to boot into the newly installed Windows for at least once otherwise the installation won&rsquo;t be passing if we move it to a flash drive without this step.</p><p>During the second part of installation make sure network is disconnected since we don&rsquo;t want Windows to install drivers for the virtual environment automatically. However, the installer most likely doesn&rsquo;t allow you to proceed if you don&rsquo;t have network access. To bypass it, when in that &ldquo;connect to network&rdquo; window, press <code>Shift+F10</code> and run the following command. The system will restart automatically and there should be an option allowing you to setup without network.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>&gt; oobe<span style=color:#4e9a06>\B</span>ypassNRO
</span></span></code></pre></div><p>When everything is done and boot into the Windows desktop, shutdown the VM.</p><h2 id=prepare-a-bootable-drive>Prepare a Bootable Drive</h2><p>Our drive has to be set up so that we can boot from it. For this purpose, I strongly suggest to use <code>Ventoy</code> due to the flexibility it provides. For example, you occasionally move image files around or want to boot from a differential vdisk. In that case the bootloader doesn&rsquo;t need to be updated every time.</p><p>Of course this can still be done in the old-fashion way which builds the bootloader with the <code>bcdboot</code> command but it requires manual updates of the bootloader in above cases. See how it is done in the previous step.</p><p>With that being said, install <code>Ventoy</code> on the drive. Then format the data partition (the biggest, usually the first one labeled <em>Ventoy</em>) of the drive into <code>NTFS</code> file system. Otherwise the VHD/VHDX cannot be booted.</p><p>Then copy the VHD boot plugin to the partition just formatted, that is <code>/ventoy/ventoy_vhdboot.img</code>.</p><p><strong>UPDATE</strong>: It seems like Windows does not like to be booted from Ventoy. There are chances that Windows will overwrite the bootloader on your other disks after system updates. Good job Microsoft. In that case, manually installing Windows boot manager on the drive by <code>bcdboot</code> command may be required. Unless you&rsquo;re using <a href=https://github.com/Atlas-OS/Atlas>Atlas</a> which shuts off auto update.</p><h2 id=copy-the-prepared-windows-image>Copy the Prepared Windows Image</h2><p>Keep the flash drive plugged in and pass it through to the VM so that the VM can access it.</p><p>Boot from the Windows ISO image inside of the VM. Don&rsquo;t start the installation and press <code>Shift+F10</code> to open a command line prompt just like earlier.</p><p>Use <code>diskpart</code> to identify volumes mounted.</p><p></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>&gt; diskpart
</span></span><span style=display:flex><span>&gt; list volume
</span></span><span style=display:flex><span>&gt; <span style=color:#204a87>exit</span>
</span></span></code></pre></div><p>Then copy the prepared Windows image to the flash drive (assuming the VM data partition is <code>D:</code> and the drive data partition is <code>F:</code>).</p><p>I use <a href=https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/robocopy>robocopy</a> as an example.</p><p></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>&gt; robocopy d:<span style=color:#4e9a06>\ </span>f:<span style=color:#4e9a06>\ </span>win.vhdx /mt /z
</span></span></code></pre></div><p>Done!</p><h2 id=finalize-the-installation>Finalize the Installation</h2><p>Now the drive is ready to use on the target machine. Boot from it and install any missing drivers and system updates.</p><p>For advanced use cases, a <a href="https://learn.microsoft.com/en-us/previous-versions/windows/desktop/legacy/dd323654(v=vs.85)">differencing virtual disk</a> can be created so that if the system is broken at some point we can quickly recover from it by discarding the old one and create a new one, or make the system read-only.</p></div></div><script src=https://peromage.github.io/js/mathjax.3.2.2.tex-svg.min.js></script><div class=bottombar><div class=bottombar-sticky><div class=icons><span class=icons-item><a href=https://github.com/peromage target=_blank><i class="fab fa-github"></i></a> </span><span class=icons-item><a href=https://www.linkedin.com/in/fangdeng/ target=_blank><i class="fab fa-linkedin fa-1x"></i></a> </span><span class=icons-item><a href=mailto:fang@elfang.com><i class="fas fa-envelope fa-1x"></i></a> </span><span class=icons-item><a href=/me.pub><i class="fas fa-key fa-1x"></i></a></span></div><div class=footer><p>&copy; 2025 , <a href=https://peromage.github.io/license/>License</a><br><a href=/privacy title="Privacy notice">Privacy notice</a></p></div></div></div></body></html>